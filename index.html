<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Magazzino</title>

<!-- Manifest PWA -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#4f46e5">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
    --color-primary: #4f46e5;
    --color-secondary: #6c757d;
    --color-success: #28a745;
    --color-warning: #ffc107;
    --color-danger: #dc3545;
    --color-background: #f8fafc;
    --color-surface: #ffffff;
    --color-text: #212529;
    --border-radius: 8px;
    --shadow: 0 2px 4px rgba(0,0,0,0.1);
}

body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: var(--color-background);
    color: var(--color-text);
}

.container {
    width: 95%;
    max-width: 1200px;
    margin: auto;
    padding: 20px;
    background-color: var(--color-surface);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
}

h1 { text-align:center; color:var(--color-primary); margin-bottom:20px; }

.tabs { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
.tab-button {
    padding:10px 15px;
    cursor:pointer;
    border:none;
    background-color:var(--color-secondary);
    color:white;
    font-weight:bold;
    border-radius: var(--border-radius);
    flex:1;
    text-align:center;
}
.tab-button.active { background-color: var(--color-primary); }

.tab-content { display:none; margin-top:15px; }
.tab-content.active { display:block; }

.form-group { margin-bottom:12px; }
.form-group label { display:block; margin-bottom:4px; font-weight:600; }
.form-group input, .form-group select {
    width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;
}

.btn-toolbar { display:flex; gap:10px; flex-wrap:wrap; margin-top:15px; }
button { cursor:pointer; border:none; padding:10px; border-radius:6px; font-weight:bold; }

.btn-primary { background-color: var(--color-primary); color:white; }
.btn-success { background-color: var(--color-success); color:white; }
.btn-danger { background-color: var(--color-danger); color:white; }
.btn-secondary { background-color: var(--color-secondary); color:white; }

#status-output { width:100%; padding:10px; margin-top:15px; border:1px solid var(--color-secondary); border-radius:4px; background-color:#eee; }

.summary-container { display:flex; flex-wrap:wrap; gap:15px; margin-top:15px; }
.summary-box { flex:1; padding:10px; border-radius:var(--border-radius); box-shadow:var(--shadow); background-color:#e9ecef; }

table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #ddd; padding:8px; text-align:left; }
th { background-color:var(--color-primary); color:white; cursor:pointer; }
tr:nth-child(even) { background-color:#f2f2f2; }
tr:hover { background-color:#ddd; }
.selected-row { background-color: var(--color-warning) !important; border:2px solid var(--color-primary); }

@media(min-width:768px){
    .container { width:98%; }
    table { font-size:0.95rem; }
}
</style>
</head>

<body>

<div class="container">
<h1>Gestione Magazzino PWA</h1>
<input type="text" id="status-output" value="Inizializzazione..." readonly>

<div class="tabs">
    <button class="tab-button active" data-tab="tab-acquisti">Nuovo Acquisto</button>
    <button class="tab-button" data-tab="tab-gestione">Modifica / Vendita / Elimina</button>
    <button class="tab-button" data-tab="tab-inventario">Inventario & Filtri</button>
</div>

<div id="tab-acquisti" class="tab-content active">
    <div class="form-group">
        <label for="data-acquisto">Data Acquisto</label>
        <input type="date" id="data-acquisto" required>
    </div>
    <div class="form-group">
        <label for="articolo-acquisto">Articolo</label>
        <input type="text" id="articolo-acquisto" placeholder="Nome Articolo" required>
    </div>
    <div class="form-group">
        <label for="prezzo-acquisto">Prezzo Acquisto (€)</label>
        <input type="number" step="0.01" id="prezzo-acquisto" placeholder="0.00" required>
    </div>
    <div class="form-group">
        <label for="guadagno-previsto">Guadagno Previsto (€)</label>
        <input type="number" step="0.01" id="guadagno-previsto" placeholder="0.00">
    </div>
    <button id="btn-acquisto" class="btn-primary">Registra Acquisto</button>
</div>

<div id="tab-gestione" class="tab-content">
    <div class="form-group">
        <label for="id-modifica">ID Movimento Selezionato</label>
        <input type="text" id="id-modifica" readonly style="font-weight:bold; background-color:#fff3cd;">
    </div>
    <div class="form-group">
        <label for="nuovo-articolo">Nuovo Articolo</label>
        <input type="text" id="nuovo-articolo">
    </div>
    <div class="form-group">
        <label for="nuovo-acquisto">Nuovo Prezzo Acquisto (€)</label>
        <input type="number" step="0.01" id="nuovo-acquisto">
    </div>
    <div class="form-group">
        <label for="prezzo-vendita">Prezzo Vendita (€)</label>
        <input type="number" step="0.01" id="prezzo-vendita">
    </div>
    <div class="btn-toolbar">
        <button id="btn-modifica" class="btn-secondary" disabled>Modifica Dati</button>
        <button id="btn-vendita" class="btn-success" disabled>Registra Vendita</button>
        <button id="btn-elimina" class="btn-danger" disabled>Elimina Movimento</button>
    </div>
</div>

<div id="tab-inventario" class="tab-content">
    <div class="form-group">
        <label for="filtro-data">Filtra per Data</label>
        <input type="date" id="filtro-data">
    </div>
    <div class="form-group">
        <label for="filtro-stato">Filtra per Stato</label>
        <select id="filtro-stato">
            <option value="Tutto">Tutto</option>
            <option value="Acquistato">Acquistato</option>
            <option value="Venduto">Venduto</option>
            <option value="Giacenza">Giacenza &gt;14gg</option>
        </select>
    </div>
    <div class="btn-toolbar">
        <button id="btn-filtra" class="btn-primary">Applica Filtri</button>
        <button id="btn-reset-all" class="btn-secondary">Reset Filtri</button>
    </div>
    <div class="summary-container">
        <div id="global-output" class="summary-box"></div>
        <div id="daily-output" class="summary-box"></div>
    </div>
</div>

<h2>Movimenti Registrati</h2>
<table>
    <thead>
        <tr>
            <th>ID</th><th>Data</th><th>Articolo</th>
            <th>Acquisto</th><th>Vendita</th>
            <th>Guadagno Previsto</th><th>Stato</th>
            <th>Profitto Netto</th><th>⚠️ Attenzione</th>
        </tr>
    </thead>
    <tbody id="table-body"></tbody>
</table>

</div>

<script>
// === CONFIG SUPABASE ===
const SUPABASE_URL = 'https://zyrlkjxxqzweetlkehrz.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJ...'; 
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// UI Elements
const tableBody = document.getElementById('table-body');
const statusOutput = document.getElementById('status-output');
const globalOutput = document.getElementById('global-output');
const dailyOutput = document.getElementById('daily-output');
let selectedRowId = null;

const btnVendita = document.getElementById('btn-vendita');
const btnModifica = document.getElementById('btn-modifica');
const btnElimina = document.getElementById('btn-elimina');
const idModificaInput = document.getElementById('id-modifica');
const nuovoArticoloInput = document.getElementById('nuovo-articolo');
const nuovoAcquistoInput = document.getElementById('nuovo-acquisto');
const prezzoVenditaInput = document.getElementById('prezzo-vendita');

// --- Service Worker ---
if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('/mercatino/sw.js')
        .then(reg=>console.log('✅ SW registrato:', reg.scope))
        .catch(err=>console.error('❌ SW fallito:', err));
    });
}

// --- Tabs ---
document.querySelectorAll('.tab-button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
    });
});

// --- Install prompt for Desktop ---
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    const btn = document.createElement('button');
    btn.textContent = "Aggiungi a Desktop";
    btn.className = "btn-primary";
    btn.style.position = "fixed";
    btn.style.top = "10px";
    btn.style.right = "10px";
    btn.style.zIndex = "1000";
    btn.onclick = async ()=>{
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        console.log('Installazione scelta:', choice.outcome);
        deferredPrompt = null;
        btn.remove();
    };
    document.body.appendChild(btn);
});

// --- Utility ---
function setStatus(msg){ statusOutput.value = msg; }
function formatCurrency(v){ return `€${parseFloat(v).toFixed(2)}`; }

// TODO: Aggiungere qui tutte le funzioni CRUD e refreshData
// Le logiche che già hai vanno bene, basta incollarle qui dentro
</script>
</body>
</html>
