<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Gestione Inventario PWA</title>

<!-- Manifest PWA -->
<link rel="manifest" href="/mercatino/manifest.json">
<meta name="theme-color" content="#007bff">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    :root {
        --color-primary: #007bff;
        --color-secondary: #6c757d;
        --color-success: #28a745;
        --color-warning: #ffc107;
        --color-danger: #dc3545;
        --color-background: #f8f9fa;
        --color-surface: #ffffff;
        --color-text: #212529;
        --border-radius: 8px;
        --shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: var(--color-background); color: var(--color-text); }
    .container { max-width: 480px; margin:auto; padding:10px; }
    h1 { text-align:center; color: var(--color-primary); margin:10px 0; }

    /* --- Card per tabella --- */
    .card { background: var(--color-surface); padding:10px; border-radius: var(--border-radius); box-shadow: var(--shadow); overflow-x:auto; margin-bottom:15px; }
    table { width:100%; border-collapse:collapse; font-size:0.9rem; }
    th, td { border:1px solid #ddd; padding:6px; text-align:left; }
    th { background-color: var(--color-primary); color:white; font-size:0.8rem; }

    /* --- Form e input --- */
    input[type=text], input[type=number], input[type=date], select { width:100%; padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
    button { padding:10px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:5px; margin-bottom:5px; }
    .btn-primary { background: var(--color-primary); color:white; }
    .btn-success { background: var(--color-success); color:white; }
    .btn-danger { background: var(--color-danger); color:white; }
    .btn-secondary { background: var(--color-secondary); color:white; }

    /* --- Tabs --- */
    .tabs { display:flex; margin-bottom:10px; }
    .tab-button { flex:1; padding:8px; background:#eee; border:none; cursor:pointer; font-weight:bold; }
    .tab-button.active { background: var(--color-primary); color:white; }
    .tab-content { display:none; margin-bottom:10px; }
    .tab-content.active { display:block; }

    /* --- Summary --- */
    .summary-box { padding:10px; border-radius: var(--border-radius); background:#e9ecef; margin-bottom:10px; }
    .summary-value { font-weight:bold; color:var(--color-success); }
    .profit-positive { color:var(--color-success); font-weight:bold; }
    .profit-negative { color:var(--color-danger); font-weight:bold; }

    /* --- Righe selezionate --- */
    .selected-row { background: var(--color-warning) !important; border:2px solid var(--color-primary); }
</style>
</head>
<body>
<div class="container">
    <h1>Gestione Inventario PWA</h1>

    <input type="text" id="status-output" value="Inizializzazione..." readonly style="width:100%; padding:6px; margin-bottom:10px;">

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-button active" data-tab="tab-acquisti">Nuovo Acquisto</button>
        <button class="tab-button" data-tab="tab-gestione">Modifica/Vendita/Elimina</button>
        <button class="tab-button" data-tab="tab-inventario">Inventario & Filtri</button>
    </div>

    <!-- Contenuti Tabs -->
    <div id="tab-acquisti" class="tab-content active">
        <h2>Registra Nuovo Acquisto</h2>
        <input type="date" id="data-acquisto">
        <input type="text" id="articolo-acquisto" placeholder="Nome Articolo">
        <input type="number" id="prezzo-acquisto" placeholder="Prezzo Acquisto (€)" step="0.01">
        <input type="number" id="guadagno-previsto" placeholder="Guadagno Previsto (€)" step="0.01">
        <button id="btn-acquisto" class="btn-primary">Registra Acquisto</button>
    </div>

    <div id="tab-gestione" class="tab-content">
        <h2>Gestione Movimento</h2>
        <input type="text" id="id-modifica" readonly placeholder="ID Selezionato">
        <input type="text" id="nuovo-articolo" placeholder="Nuovo Articolo">
        <input type="number" id="nuovo-acquisto" placeholder="Nuovo Prezzo Acquisto">
        <input type="number" id="prezzo-vendita" placeholder="Prezzo Vendita">
        <button id="btn-modifica" class="btn-secondary">Modifica</button>
        <button id="btn-vendita" class="btn-success">Registra Vendita</button>
        <button id="btn-elimina" class="btn-danger">Elimina</button>
    </div>

    <div id="tab-inventario" class="tab-content">
        <h2>Filtri Inventario</h2>
        <input type="date" id="filtro-data">
        <select id="filtro-stato">
            <option value="Tutto">Tutto</option>
            <option value="Acquistato">Acquistato</option>
            <option value="Venduto">Venduto</option>
            <option value="Giacenza">Giacenza (>14gg)</option>
        </select>
        <button id="btn-filtra" class="btn-primary">Applica Filtri</button>
        <button id="btn-reset-all" class="btn-secondary">Reset Filtri</button>

        <div class="summary-box" id="global-output"></div>
        <div class="summary-box" id="daily-output"></div>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Data</th>
                    <th>Articolo</th>
                    <th>Acquisto</th>
                    <th>Vendita</th>
                    <th>Guadagno Previsto</th>
                    <th>Stato</th>
                    <th>Profitto Netto</th>
                    <th>⚠️ Attenzione</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://zyrlkjxxqzweetlkehrz.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5cmxranh4cXp3ZWV0bGtlaHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NDg2OTEsImV4cCI6MjA3NzAyNDY5MX0.Gw23ftfgXfpZ_JKTz29txmLuIgnJCcuj8O1SMNh6qRc';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const tableBody = document.getElementById('table-body');
const statusOutput = document.getElementById('status-output');
const globalOutput = document.getElementById('global-output');
const dailyOutput = document.getElementById('daily-output');
let selectedRowId = null;

const btnVendita = document.getElementById('btn-vendita');
const btnModifica = document.getElementById('btn-modifica');
const btnElimina = document.getElementById('btn-elimina');
const idModificaInput = document.getElementById('id-modifica');
const nuovoArticoloInput = document.getElementById('nuovo-articolo');
const nuovoAcquistoInput = document.getElementById('nuovo-acquisto');
const prezzoVenditaInput = document.getElementById('prezzo-vendita');

let offlineQueue = [];
const QUEUE_KEY = 'supabase_offline_queue';

if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/mercatino/sw.js')
        .then(reg => console.log('✅ SW registrato:', reg.scope))
        .catch(err => console.error('❌ SW fallito:', err));
    });
}

// --- Utility ---
function setStatus(msg) { statusOutput.value = msg; }
function formatCurrency(v) { return `€${parseFloat(v||0).toFixed(2)}`; }

function setupTabs() {
    document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
    }));
}

// --- Offline Queue ---
function saveQueue() { localStorage.setItem(QUEUE_KEY, JSON.stringify(offlineQueue)); updateOfflineStatus(); }
function loadQueue() { const sq = localStorage.getItem(QUEUE_KEY); if(sq) offlineQueue=JSON.parse(sq); updateOfflineStatus(); }
function updateOfflineStatus() { 
    const c = offlineQueue.length;
    if(c>0){ setStatus(`⚠️ ${navigator.onLine?'Online':'Offline'}: ${c} operazioni in coda!`); document.body.style.border='5px solid var(--color-warning)';}
    else{ if(navigator.onLine){setStatus("✅ Dati sincronizzati."); document.body.style.border='none';} else {setStatus("❌ Offline, dati non aggiornati."); document.body.style.border='5px solid var(--color-danger)';} }
}
async function attemptSync(){
    if(!navigator.onLine||offlineQueue.length===0) return;
    let items=[...offlineQueue]; offlineQueue=[]; let success=0, errors=0;
    for(const item of items){
        try{
            let res={error:{message:"Unknown error"}};
            if(item.action==='INSERT') res=await supabaseClient.from('movimenti').insert([item.payload]).select();
            else if(item.action==='UPDATE') res=await supabaseClient.from('movimenti').update(item.payload).eq('id',item.id);
            else if(item.action==='DELETE') res=await supabaseClient.from('movimenti').delete().eq('id',item.id);
            if(res&&!res.error) success++; else { errors++; offlineQueue.push(item); console.error('Errore sync',res.error.message);}
        }catch(e){ errors++; offlineQueue.push(item); console.error('Errore fetch',e);}
    }
    saveQueue(); await refreshData();
    setStatus(success>0?`✅ Sincronizzazione: ${success} riuscite, ${errors} fallite.`:`❌ Sync fallita, ${errors} in coda.`);
}

// --- CRUD Helpers ---
function handleCrudError(err, action, payload, id=null){
    if(err.message && err.message.includes("Failed to fetch")){
        offlineQueue.push({action,id,payload});
        saveQueue(); setStatus(`⚠️ Operazione ${action} salvata offline (${offlineQueue.length})`);
        refreshData();
    }else setStatus(`❌ Errore DB: ${err.message}`);
}

// --- Funzioni principali ---
async function addAcquisto(){
    const data=document.getElementById('data-acquisto').value||new Date().toISOString().split('T')[0];
    const articolo=document.getElementById('articolo-acquisto').value.trim();
    const prezzo=parseFloat(document.getElementById('prezzo-acquisto').value);
    const guadagno=parseFloat(document.getElementById('guadagno-previsto').value)||0;
    if(!articolo||isNaN(prezzo)||prezzo<=0){ setStatus("⚠️ Inserisci articolo e prezzo >0"); return;}
    const newRow={data,articolo,acquisto:prezzo,vendita:0,guadagno_previsto:guadagno,stato:'Acquistato'};
    const {data:newData,error}=await supabaseClient.from('movimenti').insert([newRow]).select();
    if(error) handleCrudError(error,'INSERT',newRow);
    else { setStatus(`✅ Acquisto registrato (ID ${newData[0].id})`); refreshData(); document.getElementById('articolo-acquisto').value=''; document.getElementById('prezzo-acquisto').value=''; document.getElementById('guadagno-previsto').value='';}
}

async function updateMovimento(isVendita=false){
    const id=selectedRowId;
    if(isNaN(id)||id<=0){ setStatus("⚠️ Seleziona ID valido"); return;}
    const payload={}; const msgs=[];
    if(nuovoArticoloInput.value.trim()) {payload.articolo=nuovoArticoloInput.value.trim(); msgs.push("✏️ Articolo");}
    if(nuovoAcquistoInput.value.trim()) {payload.acquisto=parseFloat(nuovoAcquistoInput.value); msgs.push("💸 Acquisto");}
    if(isVendita||prezzoVenditaInput.value.trim()){payload.vendita=parseFloat(prezzoVenditaInput.value)||0; payload.stato='Venduto'; msgs.push("💰 Vendita");}
    if(Object.keys(payload).length===0){ setStatus("ℹ️ Nessuna modifica"); return;}
    const {error}=await supabaseClient.from('movimenti').update(payload).eq('id',id);
    if(error) handleCrudError(error,'UPDATE',payload,id);
    else { setStatus(msgs.join(' • ')); clearManagementFields(); refreshData();}
}

async function deleteMovimento(){
    const id=selectedRowId;
    if(isNaN(id)||id<=0){ setStatus("⚠️ Seleziona ID valido"); return;}
    if(!confirm(`Eliminare ID ${id}?`)) return;
    const {error}=await supabaseClient.from('movimenti').delete().eq('id',id);
    if(error) handleCrudError(error,'DELETE',null,id);
    else { setStatus(`🗑️ ID ${id} eliminato`); clearManagementFields(); refreshData();}
}

// --- Rendering ---
function clearManagementFields(){ selectedRowId=null; idModificaInput.value=''; nuovoArticoloInput.value=''; nuovoAcquistoInput.value=''; prezzoVenditaInput.value=''; updateManagementButtons();}
function updateManagementButtons(){ const isSelected=selectedRowId>0; btnVendita.disabled=!isSelected; btnModifica.disabled=!isSelected; btnElimina.disabled=!isSelected; const o=isSelected?'1':'0.7'; btnVendita.style.opacity=o; btnModifica.style.opacity=o; btnElimina.style.opacity=o; if(!isSelected) document.querySelectorAll('.selected-row').forEach(r=>r.classList.remove('selected-row'));}
async function refreshData(){ const fd=document.getElementById('filtro-data').value; const fs=document.getElementById('filtro-stato').value; await loadDataAndRender(fd,fs); updateOfflineStatus();}
async function resetAll(){ document.getElementById('filtro-data').value=''; document.getElementById('filtro-stato').value='Tutto'; await loadDataAndRender(null,'Tutto'); }

async function loadDataAndRender(filterDate=null, filterStato='Tutto'){
    setStatus("⏳ Caricamento dati...");
    let q = supabaseClient.from('movimenti').select('*').order('id',{ascending:false});
    if(filterDate) q=q.eq('data',filterDate);
    if(filterStato==='Acquistato'||filterStato==='Venduto') q=q.eq('stato',filterStato);
    const {data:movimenti,error}=await q;
    if(error){ setStatus(`❌ Errore: ${error.message}`); return;}
    const processed=movimenti.map(m=>{
        const acquisto=m.acquisto||0, vendita=m.vendita||0, profitto=vendita-acquisto;
        let att="";
        if(m.stato==='Acquistato'){ const d0=new Date(), d1=new Date(m.data); const diff=Math.floor((d0-d1)/(1000*60*60*24)); if(diff>14) att=`🔴 ${diff}gg giacenza`;}
        return {...m, profitto, '⚠️ Attenzione':att};
    });
    renderTable(processed);
    calculateAndRenderSummaries(movimenti,processed);
}

function renderTable(data){ tableBody.innerHTML=''; data.forEach(m=>{
    const row=tableBody.insertRow(); row.setAttribute('data-id',m.id);
    row.innerHTML=`<td>${m.id}</td><td>${m.data}</td><td>${m.articolo}</td><td>${formatCurrency(m.acquisto)}</td><td>${formatCurrency(m.vendita)}</td><td>${formatCurrency(m.guadagno_previsto)}</td><td>${m.stato}</td><td style="font-weight:700;">${formatCurrency(m.profitto)}</td><td>${m['⚠️ Attenzione']}</td>`;
});}

async function calculateAndRenderSummaries(globalData, filteredData){
    let tot_a=0, tot_v=0, profit=0;
    if(globalData && globalData.length>0){
        tot_a=globalData.reduce((s,i)=>s+(i.acquisto||0),0);
        tot_v=globalData.reduce((s,i)=>s+(i.vendita||0),0);
        profit=tot_v-tot_a;
    }
    globalOutput.innerHTML=`<h3>🌎 Totale Generale</h3><p>Acquisti: ${formatCurrency(tot_a)}</p><p>Vendite: ${formatCurrency(tot_v)}</p><p>Profitto: <span class="${profit>=0?'profit-positive':'profit-negative'}">${formatCurrency(profit)}</span></p>`;
    const da=filteredData.reduce((s,m)=>s+(m.acquisto||0),0);
    const dv=filteredData.reduce((s,m)=>s+(m.vendita||0),0);
    const dp=dv-da;
    dailyOutput.innerHTML=`<h3>📅 Riepilogo Filtri</h3><p>Acquisti: ${formatCurrency(da)} | Vendite: ${formatCurrency(dv)}</p><p>Profitto: <span class="${dp>=0?'profit-positive':'profit-negative'}">${formatCurrency(dp)}</span></p>`;
}

// --- Event listeners ---
document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('data-acquisto').value=new Date().toISOString().split('T')[0];
    setupTabs(); loadQueue(); loadDataAndRender(); updateManagementButtons();
    window.addEventListener('online',attemptSync);
    document.getElementById('btn-acquisto').addEventListener('click', addAcquisto);
    document.getElementById('btn-modifica').addEventListener('click', ()=>updateMovimento(false));
    document.getElementById('btn-vendita').addEventListener('click', ()=>updateMovimento(true));
    document.getElementById('btn-elimina').addEventListener('click', deleteMovimento);
    document.getElementById('btn-filtra').addEventListener('click', refreshData);
    document.getElementById('btn-reset-all').addEventListener('click', resetAll);

    tableBody.addEventListener('click', e=>{
        const row=e.target.closest('tr'); if(!row) return;
        const currentId=parseInt(row.getAttribute('data-id'));
        if(selectedRowId===currentId){ row.classList.remove('selected-row'); clearManagementFields(); setStatus("ℹ️ Nessun movimento selezionato"); return;}
        document.querySelectorAll('.selected-row').forEach(r=>r.classList.remove('selected-row'));
        selectedRowId=currentId; row.classList.add('selected-row');
        const cols=Array.from(row.querySelectorAll('td')).map(td=>td.textContent.trim());
        idModificaInput.value=cols[0]; nuovoArticoloInput.value=cols[2];
        nuovoAcquistoInput.value=cols[3].replace('€',''); prezzoVenditaInput.value=cols[4].replace('€','');
        setStatus(`ℹ️ ID ${selectedRowId} selezionato`);
        updateManagementButtons(); document.querySelector('.tab-button[data-tab="tab-gestione"]').click();
    });
});

// --- PWA install prompt ---
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt=e;
    const btn=document.createElement('button');
    btn.textContent="Aggiungi a Home";
    btn.className="btn-primary";
    btn.onclick=async ()=>{
        deferredPrompt.prompt();
        const choice=await deferredPrompt.userChoice;
        console.log('Installazione scelta:', choice.outcome);
        deferredPrompt=null; btn.remove();
    };
    document.body.prepend(btn);
});
</script>
</body>
</html>
