<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Inventario PWA</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- STILE PRINCIPALE --- */
        :root {
            --color-primary: #007bff;
            --color-secondary: #6c757d;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-background: #f8f9fa;
            --color-surface: #ffffff;
            --color-text: #212529;
            --border-radius: 8px;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);

        }

        body { font-family: Arial,sans-serif; margin:0; padding:0; background:var(--color-background); color:var(--color-text); }
        .container { max-width: 1200px; margin:auto; padding:20px; background:var(--color-surface); box-shadow:var(--shadow); border-radius:var(--border-radius); }
        h1 { text-align:center; color:var(--color-primary); margin-bottom:20px; }

        /* Tab system */
        .tabs { display:flex; border-bottom:2px solid #ddd; margin-bottom:20px; }
        .tab-button { padding:10px 15px; cursor:pointer; border:none; background:transparent; color:var(--color-secondary); font-weight:bold; }
        .tab-button.active { color:var(--color-primary); border-bottom:3px solid var(--color-primary); }
        .tab-content { display:none; padding:15px 0; }
        .tab-content.active { display:block; }

        /* Form */
        .form-group { margin-bottom:15px; }
        .form-group label { display:block; margin-bottom:5px; font-weight:600; }
        .form-group input, .form-group select { width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
        .form-row { display:flex; gap:20px; }
        .form-row .form-group { flex:1; }
        button { padding:10px 15px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; transition:0.2s; }
        button:disabled { opacity:0.5; cursor:not-allowed; }
        .btn-primary { background:var(--color-primary); color:white; }
        .btn-success { background:var(--color-success); color:white; }
        .btn-danger { background:var(--color-danger); color:white; }
        .btn-secondary { background:var(--color-secondary); color:white; }
        .btn-toolbar { display:flex; gap:10px; margin-top:20px; }

        /* Status & summary */
        #status-output { width:100%; margin-top:20px; padding:10px; border:1px solid var(--color-secondary); border-radius:4px; background:#eee; }
        .summary-container { display:flex; gap:20px; margin-top:20px; padding-top:20px; border-top:1px solid #ddd; }
        .summary-box { flex:1; padding:15px; border-radius:var(--border-radius); box-shadow:var(--shadow); background:#e9ecef; }

        .profit-positive { color:var(--color-success); font-weight:bold; }
        .profit-negative { color:var(--color-danger); font-weight:bold; }

        /* Table */
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th,td { border:1px solid #ddd; padding:8px; text-align:left; }
        th { background-color:var(--color-primary); color:white; cursor:pointer; }
        tr:nth-child(even) { background-color:#f2f2f2; }
        tr:hover { background-color:#ddd; }
        .selected-row { background-color:var(--color-warning)!important; border:2px solid var(--color-primary); }


.card-table {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 16px;
    margin-bottom: 20px;
}

.table-container {
    max-height: 400px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead th {
    position: sticky;
    top: 0;
    background: #f3f4f6;
    z-index: 1;
}

tbody tr:hover {
    background: #f1f5f9;
}

    </style>
</head>
<body>

<div class="container">
    <h1>Gestione Inventario PWA</h1>
    <input type="text" id="status-output" value="Inizializzazione..." readonly>

    <!-- Tab Buttons -->
    <div class="tabs">
        <button class="tab-button active" data-tab="tab-acquisti">Nuovo Acquisto</button>
        <button class="tab-button" data-tab="tab-gestione">Gestione Movimento</button>
        <button class="tab-button" data-tab="tab-inventario">Filtri / Riepilogo</button>
    </div>

    <!-- Tab Acquisti -->
    <div id="tab-acquisti" class="tab-content active">
        <h2>Registra Nuovo Acquisto</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="data-acquisto">Data Acquisto</label>
                <input type="date" id="data-acquisto">
            </div>
            <div class="form-group">
                <label for="articolo-acquisto">Articolo</label>
                <input type="text" id="articolo-acquisto" placeholder="Nome Articolo">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="prezzo-acquisto">Prezzo Acquisto (€)</label>
                <input type="number" id="prezzo-acquisto" step="0.01">
            </div>
            <div class="form-group">
                <label for="guadagno-previsto">Guadagno Previsto (€)</label>
                <input type="number" id="guadagno-previsto" step="0.01">
            </div>
        </div>
        <button id="btn-acquisto" class="btn-primary">Registra Acquisto</button>
    </div>

    <!-- Tab Gestione -->
    <div id="tab-gestione" class="tab-content">
        <h2>Gestione Movimento Selezionato</h2>
        <p>Seleziona una riga dalla tabella sottostante per abilitare le azioni.</p>
        <div class="form-group">
            <label for="id-modifica">ID Movimento Selezionato</label>
            <input type="text" id="id-modifica" readonly>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="nuovo-articolo">Nuovo Articolo</label>
                <input type="text" id="nuovo-articolo">
            </div>
            <div class="form-group">
                <label for="nuovo-acquisto">Nuovo Prezzo Acquisto (€)</label>
                <input type="number" id="nuovo-acquisto" step="0.01">
            </div>
            <div class="form-group">
                <label for="prezzo-vendita">Prezzo Vendita (€)</label>
                <input type="number" id="prezzo-vendita" step="0.01">
            </div>
        </div>
        <div class="btn-toolbar">
            <button id="btn-modifica" class="btn-secondary" disabled>Modifica</button>
            <button id="btn-vendita" class="btn-success" disabled>Registra Vendita</button>
            <button id="btn-elimina" class="btn-danger" disabled>Elimina</button>
        </div>
    </div>

    <!-- Tab Inventario / Filtri -->
    <div id="tab-inventario" class="tab-content">
        <h2>Filtri e Riepilogo</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="filtro-data">Filtra per Data</label>
                <input type="date" id="filtro-data">
            </div>
            <div class="form-group">
                <label for="filtro-stato">Filtra per Stato</label>
                <select id="filtro-stato">
                    <option value="Tutto">Tutto</option>
                    <option value="Acquistato">Acquistato</option>
                    <option value="Venduto">Venduto</option>
                    <option value="Giacenza">Giacenza &gt;14gg</option>
                </select>
            </div>
        </div>
        <div class="btn-toolbar">
            <button id="btn-filtra" class="btn-primary">Applica Filtri</button>
            <button id="btn-reset-all" class="btn-secondary">Reset Filtri</button>
        </div>

        <div class="summary-container">
            <div class="summary-box" id="global-output"></div>
            <div class="summary-box" id="daily-output"></div>
        </div>

       <div class="card-table">
    <h3>Lista Movimenti</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Data</th>
                    <th>Articolo</th>
                    <th>Acquisto</th>
                    <th>Vendita</th>
                    <th>Guadagno Previsto</th>
                    <th>Stato</th>
                    <th>Profitto</th>
                    <th>Attenzione</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

</div>

<script>
    // --- CONFIGURAZIONE SUPABASE ---
    const SUPABASE_URL = 'https://zyrlkjxxqzweetlkehrz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5cmxranh4cXp3ZWV0bGtlaHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NDg2OTEsImV4cCI6MjA3NzAyNDY5MX0.Gw23ftfgXfpZ_JKTz29txmLuIgnJCcuj8O1SMNh6qRc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- VARIABILI GLOBALI ---
    const tableBody = document.getElementById('table-body');
    const statusOutput = document.getElementById('status-output');
    const globalOutput = document.getElementById('global-output');
    const dailyOutput = document.getElementById('daily-output');
    const btnVendita = document.getElementById('btn-vendita');
    const btnModifica = document.getElementById('btn-modifica');
    const btnElimina = document.getElementById('btn-elimina');
    const idModificaInput = document.getElementById('id-modifica');
    const nuovoArticoloInput = document.getElementById('nuovo-articolo');
    const nuovoAcquistoInput = document.getElementById('nuovo-acquisto');
    const prezzoVenditaInput = document.getElementById('prezzo-vendita');
    let selectedRowId = null;

    // --- OFFLINE QUEUE ---
    let offlineQueue = [];
    const QUEUE_KEY = 'supabase_offline_queue';

    function saveQueue(){ localStorage.setItem(QUEUE_KEY, JSON.stringify(offlineQueue)); updateOfflineStatus(); }
    function loadQueue(){ const storedQueue = localStorage.getItem(QUEUE_KEY); if(storedQueue){ offlineQueue = JSON.parse(storedQueue);} updateOfflineStatus(); }

    function updateOfflineStatus(){
        const count = offlineQueue.length;
        if(count>0){
            const connectionStatus = navigator.onLine ? 'Online' : 'Offline';
            setStatus(`⚠️ ${connectionStatus}: ${count} operazioni in attesa di sincronizzazione!`);
            document.body.style.border = '5px solid var(--color-warning)';
        } else {
            if(navigator.onLine){document.body.style.border='none'; setStatus("✅ Dati caricati e sincronizzati.");} 
            else { setStatus("❌ Rete disconnessa. I dati mostrati non sono aggiornati."); document.body.style.border='5px solid var(--color-danger)';}
        }
    }

    async function attemptSync(){
        if(offlineQueue.length===0){ if(navigator.onLine) setStatus("✅ Rete online. Nessuna operazione in attesa."); return;}
        if(!navigator.onLine) return;

        setStatus(`⏳ Rete online. Tentativo di sincronizzare ${offlineQueue.length} operazioni...`);
        let successfulSyncs = 0; let errors=0;
        const itemsToProcess = [...offlineQueue]; offlineQueue=[];

        for(const item of itemsToProcess){
            try{
                let result={error:{message:"Unknown error"}};
                if(item.action==='INSERT'){result=await supabaseClient.from('movimenti').insert([item.payload]).select();}
                else if(item.action==='UPDATE'){result=await supabaseClient.from('movimenti').update(item.payload).eq('id', item.id);}
                else if(item.action==='DELETE'){result=await supabaseClient.from('movimenti').delete().eq('id', item.id);}
                if(result && !result.error){successfulSyncs++;} else {errors++; offlineQueue.push(item); console.error(`Errore ${item.action} ID ${item.id}:`,result.error.message);}
            }catch(e){errors++; offlineQueue.push(item); console.error("Errore fetch:",e);}
        }
        saveQueue(); await refreshData();
        if(successfulSyncs>0){ setStatus(`✅ Sincronizzazione completata: ${successfulSyncs} operazioni riuscite. ${errors} fallite.`);}
        else if(errors>0){ setStatus(`❌ Tentativo fallito. ${errors} operazioni rimaste in coda.`);}
    }

    function setStatus(message){ statusOutput.value=message; }

    function formatCurrency(value){ return `€${parseFloat(value||0).toFixed(2)}`; }

    function setupTabs(){
        document.querySelectorAll('.tab-button').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });
    }

    function clearManagementFields(){
        selectedRowId=null; idModificaInput.value=''; nuovoArticoloInput.value=''; nuovoAcquistoInput.value=''; prezzoVenditaInput.value=''; updateManagementButtons();
    }
    function updateManagementButtons(){
        const isSelected = selectedRowId!==null && !isNaN(selectedRowId) && selectedRowId>0;
        btnVendita.disabled=!isSelected; btnModifica.disabled=!isSelected; btnElimina.disabled=!isSelected;
        const opacityValue = isSelected?'1':'0.7';
        btnVendita.style.opacity=opacityValue; btnModifica.style.opacity=opacityValue; btnElimina.style.opacity=opacityValue;
        if(!isSelected){ document.querySelectorAll('.selected-row').forEach(row=>row.classList.remove('selected-row'));}
    }

    // --- CRUD FUNCTIONS ---
    async function addAcquisto(){
        const data = document.getElementById('data-acquisto').value || new Date().toISOString().split('T')[0];
        const articolo = document.getElementById('articolo-acquisto').value.trim();
        const prezzoAcquisto = parseFloat(document.getElementById('prezzo-acquisto').value);
        const guadagnoPrevisto = parseFloat(document.getElementById('guadagno-previsto').value)||0.0;
        if(!articolo || isNaN(prezzoAcquisto) || prezzoAcquisto<=0){setStatus("⚠️ Inserisci articolo e prezzo valido."); return;}
        setStatus("⏳ Registrazione acquisto...");
        const newRow={data, articolo, acquisto:prezzoAcquisto, vendita:0.0, guadagno_previsto:guadagnoPrevisto, stato:'Acquistato'};
        const {data:newData,error} = await supabaseClient.from('movimenti').insert([newRow]).select();
        if(error){ offlineQueue.push({action:'INSERT',payload:newRow}); saveQueue(); setStatus(`⚠️ Acquisto salvato offline. ${offlineQueue.length} in coda.`);}
        else{setStatus(`✅ Acquisto registrato (ID ${newData[0].id})`); await refreshData(); document.getElementById('articolo-acquisto').value=''; document.getElementById('prezzo-acquisto').value=''; document.getElementById('guadagno-previsto').value='';}
    }

    async function updateMovimento(isVendita=false){
        const idToEdit = selectedRowId; 
        if(isNaN(idToEdit)||idToEdit<=0){setStatus("⚠️ Seleziona un ID valido."); return;}
        const updatePayload={};
        const messages=[`ID ${idToEdit}:`];
        if(nuovoArticoloInput.value.trim()){ updatePayload.articolo=nuovoArticoloInput.value.trim(); messages.push("✏️ Articolo modificato");}
        if(nuovoAcquistoInput.value && !isNaN(parseFloat(nuovoAcquistoInput.value))){ updatePayload.acquisto=parseFloat(nuovoAcquistoInput.value); messages.push("💸 Prezzo acquisto aggiornato");}
        if(isVendita && prezzoVenditaInput.value && !isNaN(parseFloat(prezzoVenditaInput.value))){ updatePayload.vendita=parseFloat(prezzoVenditaInput.value); updatePayload.stato='Venduto'; messages.push("💰 Vendita registrata");}
        if(Object.keys(updatePayload).length===0){setStatus("ℹ️ Nessuna modifica da effettuare."); return;}
        setStatus("⏳ Aggiornamento movimento...");
        const {error} = await supabaseClient.from('movimenti').update(updatePayload).eq('id',idToEdit);
        if(error){ offlineQueue.push({action:'UPDATE',id:idToEdit,payload:updatePayload}); saveQueue(); setStatus(`⚠️ Modifica salvata offline.`);}
        else{setStatus(messages.join(" • ")); clearManagementFields(); await refreshData();}
    }

    async function deleteMovimento(){
        const idToDelete=selectedRowId;
        if(isNaN(idToDelete)||idToDelete<=0){setStatus("⚠️ Seleziona un ID valido."); return;}
        if(!confirm(`Eliminare ID ${idToDelete}?`)) return;
        setStatus("⏳ Eliminazione...");
        const {error}=await supabaseClient.from('movimenti').delete().eq('id',idToDelete);
        if(error){ offlineQueue.push({action:'DELETE',id:idToDelete}); saveQueue(); setStatus("⚠️ Eliminazione salvata offline.");}
        else{setStatus(`🗑️ ID ${idToDelete} eliminato.`); clearManagementFields(); await refreshData();}
    }

    async function loadDataAndRender(filterDate=null,filterStato='Tutto'){
        setStatus("⏳ Caricamento dati...");
        let query = supabaseClient.from('movimenti').select('*').order('id',{ascending:false});
        if(filterDate){ query=query.eq('data',filterDate);}
        if(filterStato==='Acquistato' || filterStato==='Venduto'){ query=query.eq('stato',filterStato);}
        else if(filterStato==='Giacenza'){ query=query.eq('stato','Acquistato'); }
        const {data:movimenti,error}=await query;
        if(error){setStatus(`❌ Errore caricamento: ${error.message}`); return;}
        let processedData = movimenti.map(mov=>{
            const acquisto=mov.acquisto||0;
            const vendita=mov.vendita||0;
            const profitto=vendita-acquisto;
            let attenzione="";
            if(mov.stato==='Acquistato'){ const today=new Date(); const itemDate=new Date(mov.data); const diffDays=Math.floor((today-itemDate)/(1000*60*60*24)); if(diffDays>14) attenzione=`🔴 In giacenza da ${diffDays} gg`;}
            return {...mov, profitto, '⚠️ Attenzione':attenzione};
        });
        if(filterStato==='Giacenza'){ processedData = processedData.filter(m=>m['⚠️ Attenzione']!==""); }
        renderTable(processedData); calculateAndRenderSummaries(movimenti,processedData); updateOfflineStatus();
    }

    function renderTable(data){
        tableBody.innerHTML='';
        data.forEach(mov=>{
            const row = tableBody.insertRow();
            row.dataset.id=mov.id;
            row.innerHTML=`<td>${mov.id}</td><td>${mov.data}</td><td>${mov.articolo}</td><td>${formatCurrency(mov.acquisto)}</td><td>${formatCurrency(mov.vendita)}</td><td>${formatCurrency(mov.guadagno_previsto)}</td><td>${mov.stato}</td><td>${formatCurrency(mov.profitto)}</td><td>${mov['⚠️ Attenzione']}</td>`;
        });
    }

    async function calculateAndRenderSummaries(globalData,filteredData){
        let tot_a=globalData.reduce((sum,i)=>sum+(i.acquisto||0),0);
        let tot_v=globalData.reduce((sum,i)=>sum+(i.vendita||0),0);
        let profit=tot_v-tot_a;
        globalOutput.innerHTML=`<h3>Totale Generale</h3><p>Acquisti: ${formatCurrency(tot_a)}</p><p>Vendite: ${formatCurrency(tot_v)}</p><p>Profitto: <span class="${profit>=0?'profit-positive':'profit-negative'}">${formatCurrency(profit)}</span></p>`;
        let da=filteredData.reduce((s,i)=>s+(i.acquisto||0),0);
        let dv=filteredData.reduce((s,i)=>s+(i.vendita||0),0);
        let dp=dv-da;
        dailyOutput.innerHTML=`<h3>Riepilogo Filtri</h3><p>Acquisti: ${formatCurrency(da)} | Vendite: ${formatCurrency(dv)}</p><p>Profitto: <span class="${dp>=0?'profit-positive':'profit-negative'}">${formatCurrency(dp)}</span></p>`;
    }

    async function refreshData(){ await loadDataAndRender(document.getElementById('filtro-data').value,document.getElementById('filtro-stato').value); }

    async function resetAll(){ document.getElementById('filtro-data').value=''; document.getElementById('filtro-stato').value='Tutto'; await loadDataAndRender(null,'Tutto'); }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('data-acquisto').value=new Date().toISOString().split('T')[0];
        setupTabs();
        loadQueue();
        loadDataAndRender();
        updateManagementButtons();

        window.addEventListener('online',attemptSync);

        document.getElementById('btn-acquisto').addEventListener('click',addAcquisto);
        document.getElementById('btn-modifica').addEventListener('click',()=>updateMovimento(false));
        document.getElementById('btn-vendita').addEventListener('click',()=>updateMovimento(true));
        document.getElementById('btn-elimina').addEventListener('click',deleteMovimento);
        document.getElementById('btn-filtra').addEventListener('click',refreshData);
        document.getElementById('btn-reset-all').addEventListener('click',resetAll);

        tableBody.addEventListener('click',(e)=>{
            const row = e.target.closest('tr'); if(!row) return;
            const currentId=parseInt(row.dataset.id);
            if(selectedRowId===currentId){ row.classList.remove('selected-row'); clearManagementFields(); setStatus("ℹ️ Nessun movimento selezionato."); return;}
            document.querySelectorAll('.selected-row').forEach(r=>r.classList.remove('selected-row'));
            selectedRowId=currentId; row.classList.add('selected-row');
            const cols=Array.from(row.querySelectorAll('td')).map(td=>td.textContent.trim());
            idModificaInput.value=cols[0]; nuovoArticoloInput.value=cols[2]; nuovoAcquistoInput.value=cols[3].replace('€',''); prezzoVenditaInput.value=cols[4].replace('€','');
            setStatus(`ℹ️ ID ${selectedRowId} selezionato per modifica.`); updateManagementButtons();
            document.querySelector('.tab-button[data-tab="tab-gestione"]').click();
        });
    });

    // --- SERVICE WORKER ---
    if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('/mercatino/sw.js').then(reg=>console.log('✅ SW registrato',reg.scope)).catch(err=>console.error('❌ SW fallito',err));}); }

    // --- PWA INSTALL PROMPT ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e;
        const installBtn=document.createElement('button');
        installBtn.textContent='📲 Installa App';
        installBtn.style.position='fixed'; installBtn.style.bottom='20px'; installBtn.style.right='20px'; installBtn.style.padding='10px 15px'; installBtn.style.background='#4f46e5'; installBtn.style.color='white'; installBtn.style.border='none'; installBtn.style.borderRadius='8px'; installBtn.style.cursor='pointer';
        document.body.appendChild(installBtn);
        installBtn.addEventListener('click',async()=>{
            installBtn.remove(); deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; console.log('Installazione:',outcome); deferredPrompt=null;
        });
    });
    window.addEventListener('appinstalled',()=>{ console.log('✅ App installata con successo!'); });
</script>

</body>
</html>
