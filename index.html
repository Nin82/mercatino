<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUK VALENZA</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>
    :root {
        --bg: #f1f5f9;
        --card: #ffffff;
        --primary: #4f46e5;
        --primary-light: #e0e7ff;
        --border: #cbd5e1;
        --text: #1e293b;
        --success: #10b981;
        --danger: #ef4444;
    }

    body { 
        background-color: var(--bg); 
        font-family: -apple-system, system-ui, sans-serif; 
        margin: 0; padding: 10px; overflow-x: hidden; 
    }

    .container { max-width: 1200px; margin: 0 auto; }

    /* --- FORM E BOTTONI --- */
    input, select {
        height: 50px !important;
        width: 100%;
        background-color: #fff !important;
        color: var(--text) !important;
        border: 2px solid var(--border) !important;
        border-radius: 12px !important;
        padding: 0 15px !important;
        box-sizing: border-box;
        font-size: 16px !important;
    }

    .form-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
    .form-group { flex: 1; min-width: 150px; }

    button {
        height: 50px !important;
        border-radius: 12px !important;
        font-weight: 800 !important;
        text-transform: uppercase;
        cursor: pointer;
        border: none !important;
        padding: 0 20px !important;
    }

    .btn-primary { background: var(--primary) !important; color: white !important; }
    .btn-success { background: var(--success) !important; color: white !important; }
    .btn-danger { background: var(--danger) !important; color: white !important; }
    .btn-secondary { background: #64748b !important; color: white !important; }

    /* --- TABELLA CON TESTATA FISSA --- */
    .table-container {
        max-height: 65vh; 
        overflow-y: auto; 
        overflow-x: auto; 
        border: 1px solid var(--border);
        border-radius: 12px;
        background: white;
        margin-top: 20px;
    }

    #main-table {
        width: 100%;
        border-collapse: separate; /* Necessario per lo sticky */
        border-spacing: 0;
        table-layout: fixed;
        min-width: 1100px; /* Impedisce il collasso delle 9 colonne */
    }

    #main-table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8fafc !important;
        border-bottom: 2px solid var(--border);
        padding: 12px 8px;
        font-size: 12px;
        color: #64748b;
        font-weight: 800;
    }

    #main-table td {
        padding: 12px 8px;
        text-align: center;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    /* Allineamento Articolo (Colonna 5) */
    #main-table th:nth-child(5), 
    #main-table td:nth-child(5) {
        text-align: left;
        padding-left: 20px;
    }

    /* Colore Profitto */
    .profit-positive { color: var(--success) !important; font-weight: bold; }
    .profit-negative { color: var(--danger) !important; font-weight: bold; }

    .selected-row { background-color: var(--primary-light) !important; }

    /* --- TABS E RIEPILOGHI --- */
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
    .tab-button { background: #fff; border: 1px solid var(--border) !important; height: 40px !important; }
    .tab-button.active { background: var(--primary) !important; color: white !important; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .summary-container { display: flex; gap: 10px; margin-top: 15px; }
    .summary-box { flex: 1; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); font-weight: bold; }

    /* Contenitore bottoni gestione */
.btn-toolbar { 
    display: flex; 
    gap: 8px; 
    margin-top: 20px; 
}

/* Stile specifico per Modifica, Vendita ed Elimina */
.btn-toolbar button {
    height: 35px !important;    /* Altezza ridotta (era 50) */
    font-size: 11px !important;  /* Testo pi√π tecnico e piccolo */
    padding: 0 5px !important;   /* Meno ingombro laterale */
    flex: 1;                     /* Divisi equamente in larghezza */
    border-radius: 8px !important; /* Angoli leggermente meno arrotondati */
    letter-spacing: 0.5px;       /* Testo pi√π leggibile anche se piccolo */
}

/* Effetto quando sono disabilitati (pi√π trasparenti) */
.btn-toolbar button:disabled {
    opacity: 0.4 !important;
    cursor: not-allowed;
}

/* Rimpicciolisce i box delle date per farli stare sulla stessa riga su iPhone */
#tab-inventario .form-row {
    display: flex;
    gap: 10px;
    flex-wrap: nowrap !important; /* Forza i campi a stare affiancati */
}

#tab-inventario .form-group {
    flex: 1; 
    min-width: 0; /* Permette al campo di rimpicciolirsi quanto serve */
}

#filtro-data-dal, #filtro-data-al {
    padding: 0 5px !important; /* Toglie lo spazio interno inutile */
    font-size: 13px !important; /* Rimpicciolisce il testo della data */
    text-align: center;
}

</style>

</head>
<body>

<div class="container">
    <h1>Gestione SUK Valenza</h1>
    <input type="text" id="status-output" value="Inizializzazione..." readonly>

    <!-- Tab Buttons -->
    <div class="tabs">
        <button class="tab-button active" data-tab="tab-acquisti">Nuovo Acquisto</button>
        <button class="tab-button" data-tab="tab-gestione">Gestione Movimento</button>
        <button class="tab-button" data-tab="tab-inventario">Filtri / Riepilogo</button>
    </div>

    <!-- Tab Acquisti -->
    <div id="tab-acquisti" class="tab-content active">
        <h2>Registra Nuovo Acquisto</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="data-acquisto">Data Acquisto</label>
                <input type="date" id="data-acquisto">
            </div>
            <div class="form-group">
                <label for="articolo-acquisto">Articolo</label>
                <input type="text" id="articolo-acquisto" placeholder="Nome Articolo">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="prezzo-acquisto">Prezzo Acquisto (‚Ç¨)</label>
                <input type="number" id="prezzo-acquisto" step="0.01">
            </div>
            <div class="form-group">
                <label for="guadagno-previsto">Guadagno Previsto (‚Ç¨)</label>
                <input type="number" id="guadagno-previsto" step="0.01">
            </div>
        </div>
        <button id="btn-acquisto" class="btn-primary">Registra Acquisto</button>


        <div class="card" style="margin-top: 15px; padding: 0;">
    <button type="button" onclick="toggleChart()" style="width: 100%; background: none; border: none; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
        <span style="font-weight: bold; color: var(--color-primary);">üìä Visualizza Andamento Business</span>
        <span id="chart-arrow">‚ñº</span>
    </button>
    
    <div id="chart-container" style="display: none; padding: 0 15px 15px 15px;">
        <div style="height: 250px; position: relative;">
            <canvas id="businessChart"></canvas>
        </div>
    </div>
</div>


    </div>





    <!-- Tab Gestione -->
    <div id="tab-gestione" class="tab-content">
        <h2>Gestione Movimento Selezionato</h2>
        <p>Seleziona una riga da TAB "sezione riepilogo" per proseguire.</p>
        <div class="form-group">
            <label for="id-modifica">ID Movimento Selezionato</label>
            <input type="text" id="id-modifica" readonly>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="nuovo-articolo">Nuovo Articolo</label>
                <input type="text" id="nuovo-articolo">
            </div>
            <div class="form-group">
                <label for="nuovo-acquisto">Nuovo Prezzo Acquisto (‚Ç¨)</label>
                <input type="number" id="nuovo-acquisto" step="0.01">
            </div>
            <div class="form-group">
                <label for="prezzo-vendita">Prezzo Vendita (‚Ç¨)</label>
                <input type="number" id="prezzo-vendita" step="0.01">
            </div>
        </div>
<div class="btn-toolbar">
    <button id="btn-modifica" class="btn-secondary" disabled>‚úèÔ∏è MODIFICA</button>
    <button id="btn-vendita" class="btn-success" disabled>üí∞ VENDITA</button>
    <button id="btn-elimina" class="btn-danger" disabled>üóëÔ∏è ELIMINA</button>
</div>
    </div>

    <!-- Tab Inventario / Filtri -->
    <div id="tab-inventario" class="tab-content">
    <h2 style="margin-bottom: 10px;">Filtri e Riepilogo</h2>
    
    <div style="background: #fff; padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px;">
        <div class="form-row">
            <input type="hidden" id="tipo-filtro-data" value="data">
            <div class="form-group">
                <label for="filtro-stato">üè∑Ô∏è Stato:</label>
                <select id="filtro-stato">
                    <option value="Tutto">Tutto</option>
                    <option value="Acquistato">Disponibile</option>
                    <option value="Venduto">Venduto</option>
                    <option value="Giacenza">Giacenza (>14gg)</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="filtro-data-dal">Dal:</label>
                <input type="date" id="filtro-data-dal">
            </div>
            <div class="form-group">
                <label for="filtro-data-al">Al:</label>
                <input type="date" id="filtro-data-al">
            </div>
        </div>

            <div class="btn-toolbar" style="margin-top: 10px; display: flex; gap: 10px;">
                 <button id="btn-filtra" class="btn-primary" style="flex: 1;">Applica Filtri</button>
                 <button id="btn-reset-all" class="btn-secondary" style="flex: 1;">Reset</button>
            </div>
    </div>

    <div class="summary-container">
        <div class="summary-box" id="global-output"></div>
        <div class="summary-box" id="daily-output"></div>
    </div>

    <div class="form-group" style="margin-top: 15px;">
    <label for="search-articolo">üîç Cerca Articolo:</label>
    <input type="text" id="search-articolo" placeholder="Scrivi per filtrare la tabella..." style="border-color: var(--primary) !important;">
    </div>

<div class="card-table">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; margin-bottom: 15px;">
    <h3 style="margin: 0; font-size: 1.1rem; color: #1e293b; display: flex; align-items: center; gap: 8px;">
        üì¶ Lista Movimenti
    </h3>
    <span id="counter-movimenti" 
          style="background: #3730a3; 
                 color: #ffffff !important; 
                 padding: 4px 12px; 
                 border-radius: 8px; 
                 font-size: 14px; 
                 font-weight: 900; 
                 box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                 border: 1px solid #4338ca;">
        0
    </span>
</div>
    <div class="table-container">
        <table id="main-table">
            <thead>
                <tr>
                    <th style="display:none;">ID</th> 
                    <th style="width: 100px;">DATA ACQ.</th>
                    <th style="width: 130px;">STATO</th>
                    <th style="width: 100px;">DATA VEN.</th>
                    <th style="text-align: left; width: auto;">ARTICOLO</th>
                    <th style="width: 90px;">‚Ç¨ ACQ.</th>
                    <th style="width: 90px;">‚Ç¨ VEN.</th>
                    <th style="width: 100px;">PROFITTO</th>
                    <th style="width: 85px;">GIAC.</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

</div>

<script>
    // --- CONFIGURAZIONE SUPABASE ---
    const SUPABASE_URL = 'https://zyrlkjxxqzweetlkehrz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5cmxranh4cXp3ZWV0bGtlaHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NDg2OTEsImV4cCI6MjA3NzAyNDY5MX0.Gw23ftfgXfpZ_JKTz29txmLuIgnJCcuj8O1SMNh6qRc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- VARIABILI GLOBALI ---
    const tableBody = document.getElementById('table-body');
    const statusOutput = document.getElementById('status-output');
    const globalOutput = document.getElementById('global-output');
    const dailyOutput = document.getElementById('daily-output');
    const btnVendita = document.getElementById('btn-vendita');
    const btnModifica = document.getElementById('btn-modifica');
    const btnElimina = document.getElementById('btn-elimina');
    const idModificaInput = document.getElementById('id-modifica');
    const nuovoArticoloInput = document.getElementById('nuovo-articolo');
    const nuovoAcquistoInput = document.getElementById('nuovo-acquisto');
    const prezzoVenditaInput = document.getElementById('prezzo-vendita');
    let selectedRowId = null;

    // --- OFFLINE QUEUE ---
    let offlineQueue = [];
    let movimentiGlobali = [];
    let myChart = null;
    const QUEUE_KEY = 'supabase_offline_queue';

    function saveQueue(){ localStorage.setItem(QUEUE_KEY, JSON.stringify(offlineQueue)); updateOfflineStatus(); }
    function loadQueue(){ const storedQueue = localStorage.getItem(QUEUE_KEY); if(storedQueue){ offlineQueue = JSON.parse(storedQueue);} updateOfflineStatus(); }

    function updateOfflineStatus(){
        const count = offlineQueue.length;
        if(count>0){
            const connectionStatus = navigator.onLine ? 'Online' : 'Offline';
            setStatus(`‚ö†Ô∏è ${connectionStatus}: ${count} operazioni in attesa di sincronizzazione!`);
            document.body.style.border = '5px solid var(--color-warning)';
        } else {
            if(navigator.onLine){document.body.style.border='none'; setStatus("‚úÖ Dati caricati e sincronizzati.");} 
            else { setStatus("‚ùå Rete disconnessa. I dati mostrati non sono aggiornati."); document.body.style.border='5px solid var(--color-danger)';}
        }
    }

    async function attemptSync(){
        if(offlineQueue.length===0){ if(navigator.onLine) setStatus("‚úÖ Rete online. Nessuna operazione in attesa."); return;}
        if(!navigator.onLine) return;

        setStatus(`‚è≥ Rete online. Tentativo di sincronizzare ${offlineQueue.length} operazioni...`);
        let successfulSyncs = 0; let errors=0;
        const itemsToProcess = [...offlineQueue]; offlineQueue=[];

        for(const item of itemsToProcess){
            try{
                let result={error:{message:"Unknown error"}};
                if(item.action==='INSERT'){result=await supabaseClient.from('movimenti').insert([item.payload]).select();}
                else if(item.action==='UPDATE'){result=await supabaseClient.from('movimenti').update(item.payload).eq('id', item.id);}
                else if(item.action==='DELETE'){result=await supabaseClient.from('movimenti').delete().eq('id', item.id);}
                if(result && !result.error){successfulSyncs++;} else {errors++; offlineQueue.push(item); console.error(`Errore ${item.action} ID ${item.id}:`,result.error.message);}
            }catch(e){errors++; offlineQueue.push(item); console.error("Errore fetch:",e);}
        }
        saveQueue(); await refreshData();
        if(successfulSyncs>0){ setStatus(`‚úÖ Sincronizzazione completata: ${successfulSyncs} operazioni riuscite. ${errors} fallite.`);}
        else if(errors>0){ setStatus(`‚ùå Tentativo fallito. ${errors} operazioni rimaste in coda.`);}
    }

    function setStatus(message){ statusOutput.value=message; }

    function formatCurrency(value){ return `‚Ç¨${parseFloat(value||0).toFixed(2)}`; }

function setupTabs() {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            const targetTab = document.getElementById(btn.dataset.tab);
            if (targetTab) targetTab.classList.add('active');

            // Reset solo se il clic √® "reale" (fatto dall'utente col mouse/dito)
            // e non generato dal codice (isTrusted)
            if (e.isTrusted) {
                clearManagementFields();
            }
        });
    });
}
    
function clearManagementFields() {
    selectedRowId = null; 
    idModificaInput.value = ''; 
    nuovoArticoloInput.value = ''; 
    nuovoAcquistoInput.value = ''; 
    prezzoVenditaInput.value = ''; 
    
    // SVUOTA IL MESSAGGIO DI STATO (quello verde dello screenshot)
    // Se usi statusOutput (che √® un input), facciamo cos√¨:
    if (statusOutput) statusOutput.value = "‚úÖ Pronto."; 
    
    // Se invece quel pezzo verde √® un DIV diverso, usa:
    // document.getElementById('nome-tuo-div-verde').innerText = '';

    // Rimuove l'evidenziazione azzurra
    document.querySelectorAll('.selected-row').forEach(row => row.classList.remove('selected-row'));
    
    // Disabilita i bottoni
    updateManagementButtons();
}
    
function updateManagementButtons(){
        const isSelected = selectedRowId!==null && !isNaN(selectedRowId) && selectedRowId>0;
        btnVendita.disabled=!isSelected; btnModifica.disabled=!isSelected; btnElimina.disabled=!isSelected;
        const opacityValue = isSelected?'1':'0.7';
        btnVendita.style.opacity=opacityValue; btnModifica.style.opacity=opacityValue; btnElimina.style.opacity=opacityValue;
        if(!isSelected){ document.querySelectorAll('.selected-row').forEach(row=>row.classList.remove('selected-row'));}
}

    // --- CRUD FUNCTIONS ---
 async function addAcquisto(){
        const data = document.getElementById('data-acquisto').value || new Date().toISOString().split('T')[0];
        const articolo = document.getElementById('articolo-acquisto').value.trim();
        const prezzoAcquisto = parseFloat(document.getElementById('prezzo-acquisto').value);
        const guadagnoPrevisto = parseFloat(document.getElementById('guadagno-previsto').value)||0.0;
        if(!articolo || isNaN(prezzoAcquisto) || prezzoAcquisto<=0){setStatus("‚ö†Ô∏è Inserisci articolo e prezzo valido."); return;}
        setStatus("‚è≥ Registrazione acquisto...");
        const newRow={data, articolo, acquisto:prezzoAcquisto, vendita:0.0, guadagno_previsto:guadagnoPrevisto, stato:'Acquistato'};
        const {data:newData,error} = await supabaseClient.from('movimenti').insert([newRow]).select();
        if(error){ offlineQueue.push({action:'INSERT',payload:newRow}); saveQueue(); setStatus(`‚ö†Ô∏è Acquisto salvato offline. ${offlineQueue.length} in coda.`);}
        else{setStatus(`‚úÖ Acquisto registrato (ID ${newData[0].id})`); await refreshData(); document.getElementById('articolo-acquisto').value=''; document.getElementById('prezzo-acquisto').value=''; document.getElementById('guadagno-previsto').value='';}
    }

async function updateMovimento(isVendita = false) {
    const idToEdit = selectedRowId;
    if (isNaN(idToEdit) || idToEdit <= 0) {
        setStatus("‚ö†Ô∏è Seleziona un ID valido dalla tabella.");
        return;
    }

    const updatePayload = {};
    const messages = [`ID ${idToEdit}:`];

    // 1. Logica specifica per la VENDITA
    if (isVendita) {
        const prezzoVendita = parseFloat(prezzoVenditaInput.value);
        if (isNaN(prezzoVendita) || prezzoVendita <= 0) {
            setStatus("‚ö†Ô∏è Inserisci un prezzo di vendita valido!");
            return;
        }
        updatePayload.vendita = prezzoVendita;
        updatePayload.stato = 'Venduto';
        // REGISTRA LA DATA DI OGGI:
        updatePayload.data_vendita = new Date().toISOString().split('T')[0]; 
        messages.push("üí∞ Vendita registrata");
    } 

    // 2. Logica per MODIFICA (Articolo e Prezzo Acquisto)
    // Nota: permettiamo la modifica anche durante la vendita se i campi sono pieni
    if (nuovoArticoloInput.value.trim()) {
        updatePayload.articolo = nuovoArticoloInput.value.trim();
        messages.push("‚úèÔ∏è Articolo modificato");
    }
    if (nuovoAcquistoInput.value && !isNaN(parseFloat(nuovoAcquistoInput.value))) {
        updatePayload.acquisto = parseFloat(nuovoAcquistoInput.value);
        messages.push("üí∏ Prezzo acquisto aggiornato");
    }

    // Controllo se c'√® effettivamente qualcosa da inviare
    if (Object.keys(updatePayload).length === 0) {
        setStatus("‚ÑπÔ∏è Nessuna modifica inserita.");
        return;
    }

    setStatus("‚è≥ Aggiornamento database...");

    const { error } = await supabaseClient.from('movimenti').update(updatePayload).eq('id', idToEdit);

    if (error) {
        // Gestione Offline
        offlineQueue.push({ action: 'UPDATE', id: idToEdit, payload: updatePayload });
        saveQueue();
        setStatus(`‚ö†Ô∏è Errore rete. Salvato in coda offline.`);
        console.error("Errore Supabase:", error.message);
    } else {
        // Successo
        setStatus(messages.join(" ‚Ä¢ "));
        clearManagementFields(); // Svuota i campi e disabilita bottoni
        await refreshData();     // Ricarica la tabella
    }
}

async function deleteMovimento(){
        const idToDelete=selectedRowId;
        if(isNaN(idToDelete)||idToDelete<=0){setStatus("‚ö†Ô∏è Seleziona un ID valido."); return;}
        if(!confirm(`Eliminare ID ${idToDelete}?`)) return;
        setStatus("‚è≥ Eliminazione...");
        const {error}=await supabaseClient.from('movimenti').delete().eq('id',idToDelete);
        if(error){ offlineQueue.push({action:'DELETE',id:idToDelete}); saveQueue(); setStatus("‚ö†Ô∏è Eliminazione salvata offline.");}
        else{setStatus(`üóëÔ∏è ID ${idToDelete} eliminato.`); clearManagementFields(); await refreshData();}
    }


async function loadDataAndRender() {
    const hiddenTipoData = document.getElementById('tipo-filtro-data');
    const filterStato = document.getElementById('filtro-stato').value;
    const dal = document.getElementById('filtro-data-dal').value;
    const al = document.getElementById('filtro-data-al').value;

    // 1. LOGICA AUTOMATICA: Lo stato decide quale colonna temporale usare per il filtro manuale
    if (filterStato === 'Venduto') {
        hiddenTipoData.value = 'data_vendita'; 
    } else {
        hiddenTipoData.value = 'data'; 
    }

    const tipoData = hiddenTipoData.value;
    setStatus("‚è≥ Caricamento...");

    // 2. Costruzione Query Base
    let query = supabaseClient.from('movimenti').select('*').order('id', {ascending: false});

    // 3. LOGICA DI ARCHIVIAZIONE INTELLIGENTE (Salva-Invenduti)
    if (dal || al) {
        // Se imposti date MANUALI, l'app esegue esattamente i tuoi ordini
        if (dal) query = query.gte(tipoData, dal);
        if (al) query = query.lte(tipoData, al);
        
        // Se cerchi per stato specifico mentre usi le date
        if (filterStato === 'Acquistato' || filterStato === 'Venduto') {
            query = query.eq('stato', filterStato);
        }
    } else {
        // UTILIZZO QUOTIDIANO (Senza date inserite):
        const annoCorrente = new Date().getFullYear();
        
        if (filterStato === 'Venduto') {
            // Mostra solo i venduti del 2026
            query = query.eq('stato', 'Venduto').gte('data_vendita', `${annoCorrente}-01-01`);
        } else if (filterStato === 'Acquistato' || filterStato === 'Giacenza') {
            // Mostra TUTTI gli invenduti (anche del 2025 o anni prima)
            query = query.eq('stato', 'Acquistato');
        } else {
            // "Tutti gli stati": Mostra (Acquistati di sempre) + (Venduti del 2026)
            query = query.or(`stato.eq.Acquistato,and(stato.eq.Venduto,data_vendita.gte.${annoCorrente}-01-01)`);
        }
    }

    const { data: movimenti, error } = await query;

    if (error) { 
        console.error("Errore Supabase:", error);
        setStatus("‚ùå Errore caricamento"); 
        return; 
    }
movimentiGlobali = movimenti;

    // 4. Elaborazione Dati (Mapping per profitto e giacenza)
    const processedData = movimenti.map(mov => {
        const profitto = (mov.vendita || 0) - (mov.acquisto || 0);
        let giorniGiacenza = 0;
        const dataAcq = new Date(mov.data);
        
        if (mov.stato === 'Venduto' && mov.data_vendita) {
            const dataVen = new Date(mov.data_vendita);
            giorniGiacenza = Math.floor((dataVen - dataAcq) / (1000 * 60 * 60 * 24));
        } else if (mov.data) {
            const oggi = new Date();
            giorniGiacenza = Math.floor((oggi - dataAcq) / (1000 * 60 * 60 * 24));
        }

        if (giorniGiacenza < 0) giorniGiacenza = 0;
        const allertaGiacenza = (mov.stato === 'Acquistato' && giorniGiacenza > 14);

        return { 
            ...mov, 
            profitto, 
            giacenza: giorniGiacenza, 
            isAlert: allertaGiacenza 
        };
    });

    // 5. Filtro logico extra per il tab "Giacenza" (quelli con alert üî¥)
    let finalData = processedData;
    if (filterStato === 'Giacenza') {
        finalData = processedData.filter(m => m.isAlert === true);
    }

    // 6. Rendering finale (Tabella + Riepiloghi + Contatore)
    renderTable(finalData);
    calculateAndRenderSummaries(movimenti, finalData);
    updateChart(movimenti);
    setStatus("‚úÖ Dati aggiornati.");
}


function renderTable(data) {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    const f = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });

    data.forEach(mov => {
        const tr = document.createElement('tr');
        tr.dataset.id = mov.id; 
        
        // --- BADGE STATO ---
        let statoBadge = '';
        if (mov.stato === 'Venduto') {
            statoBadge = `<span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; border: 1px solid #bbf7d0;">VENDUTO</span>`;
        } else {
            const colorAcq = mov.isAlert ? '#991b1b' : '#3730a3'; 
            const bgAcq = mov.isAlert ? '#fee2e2' : '#e0e7ff';    
            const alertIcon = mov.isAlert ? '‚ö†Ô∏è ' : '';
            statoBadge = `<span style="background: ${bgAcq}; color: ${colorAcq}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; border: 1px solid ${colorAcq};">${alertIcon}DISPONIBILE</span>`;
        }

        const dataVenLabel = mov.data_vendita ? new Date(mov.data_vendita).toLocaleDateString('it-IT') : '-';
        
        // --- LOGICA GIACENZA PULITA ---
        // Se √® venduto, mostriamo "-", altrimenti mostriamo i giorni
        const giacenzaHtml = mov.stato === 'Venduto' 
            ? `<span style="color: #94a3b8;">-</span>` 
            : (mov.isAlert 
                ? `<span style="color: #ef4444; font-weight: 800;">üî¥ ${mov.giacenza} gg</span>` 
                : `<span>${mov.giacenza} gg</span>`);

        tr.innerHTML = `
            <td style="display:none;">${mov.id}</td>
            <td>${new Date(mov.data).toLocaleDateString('it-IT')}</td>
            <td>${statoBadge}</td>
            <td>${dataVenLabel}</td>
            <td style="text-align: left; font-weight: 700;">${mov.articolo || '-'}</td>
            <td>${f.format(mov.acquisto || 0)}</td>
            <td>${mov.vendita ? f.format(mov.vendita) : '-'}</td>
            <td class="${mov.profitto >= 0 ? 'profit-positive' : 'profit-negative'}">
                ${mov.stato === 'Venduto' ? f.format(mov.profitto) : '-'}
            </td>
            <td>${giacenzaHtml}</td>
        `;
        tbody.appendChild(tr);
    });

    // --- AGGIORNAMENTO CONTATORE DINAMICO ---
    const counter = document.getElementById('counter-movimenti');
    if (counter) {
        counter.textContent = data.length;
    }
}

async function calculateAndRenderSummaries(globalData,filteredData){
        let tot_a=globalData.reduce((sum,i)=>sum+(i.acquisto||0),0);
        let tot_v=globalData.reduce((sum,i)=>sum+(i.vendita||0),0);
        let profit=tot_v-tot_a;
        globalOutput.innerHTML=`<h3>Totale Generale</h3><p>Acquisti: ${formatCurrency(tot_a)}</p><p>Vendite: ${formatCurrency(tot_v)}</p><p>Profitto: <span class="${profit>=0?'profit-positive':'profit-negative'}">${formatCurrency(profit)}</span></p>`;
        let da=filteredData.reduce((s,i)=>s+(i.acquisto||0),0);
        let dv=filteredData.reduce((s,i)=>s+(i.vendita||0),0);
        let dp=dv-da;
        dailyOutput.innerHTML=`<h3>Riepilogo Filtri</h3><p>Acquisti: ${formatCurrency(da)} | Vendite: ${formatCurrency(dv)}</p><p>Profitto: <span class="${dp>=0?'profit-positive':'profit-negative'}">${formatCurrency(dp)}</span></p>`;
    }

async function refreshData(){ 
    // Prendiamo i valori dai nuovi ID che hai nell'HTML
    const dal = document.getElementById('filtro-data-dal').value;
    const stato = document.getElementById('filtro-stato').value;
    await loadDataAndRender(); 
}

async function resetAll(){ 
    document.getElementById('filtro-data-dal').value = ''; 
    document.getElementById('filtro-data-al').value = ''; 
    document.getElementById('filtro-stato').value = 'Tutto'; 
    document.getElementById('search-articolo').value = '';
    
    // PULISCE ANCHE LA SEZIONE MODIFICA/VENDITA
    clearManagementFields(); 

    await loadDataAndRender(); 
}



// grafico
function toggleChart() {
    const container = document.getElementById('chart-container');
    const arrow = document.getElementById('chart-arrow');
    
    if (container.style.display === "none") {
        container.style.display = "block";
        arrow.textContent = "‚ñ≤";
        // Forza il refresh del grafico per adattarsi allo spazio appena aperto
        if (myChart) myChart.resize();
    } else {
        container.style.display = "none";
        arrow.textContent = "‚ñº";
    }
}

function updateChart(movimenti) {
    const canvas = document.getElementById('businessChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // 1. Ordiniamo i movimenti per data (dal pi√π vecchio al pi√π recente)
    const datiOrdinati = [...movimenti].sort((a, b) => new Date(a.data) - new Date(b.data));

    // 2. Raggruppiamo per Mese-Anno (es: "12-2025", "01-2026") per non avere troppi punti
    const raggruppati = {};

    datiOrdinati.forEach(m => {
        // Le uscite le contiamo quando hai comprato
        const dAcq = new Date(m.data);
        const labelAcq = `${dAcq.getMonth() + 1}/${dAcq.getFullYear()}`;
        if (!raggruppati[labelAcq]) raggruppati[labelAcq] = { acquisti: 0, vendite: 0 };
        raggruppati[labelAcq].acquisti += (m.acquisto || 0);
        
        // Le entrate le contiamo quando hai effettivamente venduto
        if (m.stato === 'Venduto' && m.data_vendita) {
            const dVen = new Date(m.data_vendita);
            const labelVen = `${dVen.getMonth() + 1}/${dVen.getFullYear()}`;
            if (!raggruppati[labelVen]) raggruppati[labelVen] = { acquisti: 0, vendite: 0 };
            raggruppati[labelVen].vendite += (m.vendita || 0);
        }
    });

    const labels = Object.keys(raggruppati);
    const dataAcquisti = labels.map(l => raggruppati[l].acquisti);
    const dataVendite = labels.map(l => raggruppati[l].vendite);

    if (myChart) myChart.destroy();

    myChart = new Chart(ctx, {
        type: 'line', // La linea √® meglio per vedere l'andamento nel tempo
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Uscite (Acquisti)',
                    data: dataAcquisti,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.3 // Rende la linea curva e "morbida"
                },
                {
                    label: 'Entrate (Vendite)',
                    data: dataVendite,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { callback: v => '‚Ç¨' + v }
                }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

    // --- EVENT LISTENERS ---
 document.addEventListener('DOMContentLoaded', () => {
    // Imposta data odierna di default
    const dataAcquistoInput = document.getElementById('data-acquisto');
    if (dataAcquistoInput) dataAcquistoInput.value = new Date().toISOString().split('T')[0];

    // Inizializzazioni
    setupTabs();
    loadQueue();
    loadDataAndRender();
    updateManagementButtons();

    // Eventi di rete e bottoni
    window.addEventListener('online', attemptSync);
    document.getElementById('btn-acquisto').addEventListener('click', addAcquisto);
    document.getElementById('btn-modifica').addEventListener('click', () => updateMovimento(false));
    document.getElementById('btn-vendita').addEventListener('click', () => updateMovimento(true));
    document.getElementById('btn-elimina').addEventListener('click', deleteMovimento);
    document.getElementById('btn-filtra').addEventListener('click', refreshData);
    document.getElementById('btn-reset-all').addEventListener('click', resetAll);

    // --- LISTENER TABELLA MIGLIORATO ---
    tableBody.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row) return;

        const currentId = parseInt(row.dataset.id);
        if (!currentId) return;

        // Se clicchi sulla riga gi√† selezionata, deseleziona
        if (selectedRowId === currentId) {
            row.classList.remove('selected-row');
            clearManagementFields();
            return;
        }

        // Rimuovi selezione precedente
        document.querySelectorAll('.selected-row').forEach(r => r.classList.remove('selected-row'));
        
        // Nuova selezione
        selectedRowId = currentId;
        row.classList.add('selected-row');

        // RECUPERO DATI DALLE CELLE (Indici: 4=Articolo, 5=Acquisto, 6=Vendita)
        const articolo = row.cells[4].innerText;
        
        // Pulizia Prezzo Acquisto
        let rawAcquisto = row.cells[5].innerText.replace('‚Ç¨', '').replace(/\./g, '').replace(',', '.').trim();
        
        // Pulizia Prezzo Vendita (gestisce il trattino '-')
        let rawVendita = row.cells[6].innerText.replace('‚Ç¨', '').replace(/\./g, '').replace(',', '.').trim();

        // Inserimento nei campi
        idModificaInput.value = currentId;
        nuovoArticoloInput.value = articolo;
        nuovoAcquistoInput.value = parseFloat(rawAcquisto) || 0;
        prezzoVenditaInput.value = (rawVendita === '-' || isNaN(parseFloat(rawVendita))) ? '' : rawVendita;

        setStatus(`‚ÑπÔ∏è ID ${selectedRowId} pronto.`);
        updateManagementButtons();

        // Switch al tab gestione
        const tabGestione = document.querySelector('.tab-button[data-tab="tab-gestione"]');
        if (tabGestione) tabGestione.click();
    });
});

//filtro testuale
// 2. Modifica il listener della ricerca cos√¨:
document.getElementById('search-articolo').addEventListener('input', function(e) {
    const searchText = e.target.value.toLowerCase();
    
    // Filtriamo l'array originale invece di nascondere le righe HTML
    const filtrati = movimentiGlobali.filter(mov => {
        const nomeArticolo = (mov.articolo || '').toLowerCase();
        return nomeArticolo.includes(searchText);
    });

    // Rilanciamo il rendering: il contatore si aggiorner√† da solo!
    renderTable(filtrati);
});

// 1. Il tuo codice esistente per il click
document.getElementById('btn-acquisto').addEventListener('click', () => {
    // Qui andrebbe la tua logica di salvataggio...
    setTimeout(() => document.getElementById('articolo-acquisto').focus(), 500);
});

// 2. AGGIUNGI QUESTO: permette di salvare premendo "Invio" sulla tastiera
document.getElementById('prezzo-acquisto').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        document.getElementById('btn-acquisto').click();
    }
});


    // --- SERVICE WORKER ---
    if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('/mercatino/sw.js').then(reg=>console.log('‚úÖ SW registrato',reg.scope)).catch(err=>console.error('‚ùå SW fallito',err));}); }

    // --- PWA INSTALL PROMPT ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e;
        const installBtn=document.createElement('button');
        installBtn.textContent='üì≤ Installa App';
        installBtn.style.position='fixed'; installBtn.style.bottom='20px'; installBtn.style.right='20px'; installBtn.style.padding='10px 15px'; installBtn.style.background='#4f46e5'; installBtn.style.color='white'; installBtn.style.border='none'; installBtn.style.borderRadius='8px'; installBtn.style.cursor='pointer';
        document.body.appendChild(installBtn);
        installBtn.addEventListener('click',async()=>{
            installBtn.remove(); deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; console.log('Installazione:',outcome); deferredPrompt=null;
        });
    });
    window.addEventListener('appinstalled',()=>{ console.log('‚úÖ App installata con successo!'); });


</script>

</body>
</html>
