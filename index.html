<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUK VALENZA</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>
    :root {
        --bg: #f1f5f9;
        --card: #ffffff;
        --primary: #4f46e5;
        --primary-light: #e0e7ff;
        --border: #cbd5e1;
        --text: #1e293b;
        --success: #10b981;
        --danger: #ef4444;
    }

    body { 
        background-color: var(--bg); 
        font-family: -apple-system, system-ui, sans-serif; 
        margin: 0; padding: 10px; overflow-x: hidden; 
    }

    .container { max-width: 1200px; margin: 0 auto; }

    /* --- FORM E BOTTONI --- */
    input, select {
        height: 50px !important;
        width: 100%;
        background-color: #fff !important;
        color: var(--text) !important;
        border: 2px solid var(--border) !important;
        border-radius: 12px !important;
        padding: 0 15px !important;
        box-sizing: border-box;
        font-size: 16px !important;
    }

    .form-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
    .form-group { flex: 1; min-width: 150px; }

    button {
        height: 50px !important;
        border-radius: 12px !important;
        font-weight: 800 !important;
        text-transform: uppercase;
        cursor: pointer;
        border: none !important;
        padding: 0 20px !important;
    }

    .btn-primary { background: var(--primary) !important; color: white !important; }
    .btn-success { background: var(--success) !important; color: white !important; }
    .btn-danger { background: var(--danger) !important; color: white !important; }
    .btn-secondary { background: #64748b !important; color: white !important; }

    /* --- TABELLA CON TESTATA FISSA --- */
    .table-container {
        max-height: 65vh; 
        overflow-y: auto; 
        overflow-x: auto; 
        border: 1px solid var(--border);
        border-radius: 12px;
        background: white;
        margin-top: 20px;
    }

#main-table {
        width: max-content; 
        border-collapse: separate;
        border-spacing: 0;
        table-layout: auto; 
        min-width: 100%; 
    }

    #main-table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8fafc !important;
        border-bottom: 2px solid var(--border);
        padding: 12px 8px;
        font-size: 12px;
        color: #64748b;
        font-weight: 800;
    }

    #main-table td {
        padding: 12px 8px;
        text-align: center;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    /* Allineamento Articolo (Colonna 5) */
    #main-table th:nth-child(5), 
    #main-table td:nth-child(5) {
        text-align: left;
        padding-left: 20px;
    }

.zoomable {
    -webkit-tap-highlight-color: transparent; /* Toglie il flash blu brutto su iPhone */
    user-select: none; /* Impedisce che si selezioni il testo mentre tieni premuto */
}

/* Effetto "pressione" */
.zoomable:active {
    background-color: var(--primary-light) !important;
    transition: background 0.2s;
}

    /* Colore Profitto */
    .profit-positive { color: var(--success) !important; font-weight: bold; }
    .profit-negative { color: var(--danger) !important; font-weight: bold; }

    .selected-row { background-color: var(--primary-light) !important; }

    /* --- TABS E RIEPILOGHI --- */
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
    .tab-button { background: #fff; border: 1px solid var(--border) !important; height: 40px !important; }
    .tab-button.active { background: var(--primary) !important; color: white !important; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .summary-container { display: flex; gap: 10px; margin-top: 15px; }
    .summary-box { flex: 1; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); font-weight: bold; }

    /* Contenitore bottoni gestione */
.btn-toolbar { 
    display: flex; 
    gap: 8px; 
    margin-top: 20px; 
}

/* Stile specifico per Modifica, Vendita ed Elimina */
.btn-toolbar button {
    height: 35px !important;    /* Altezza ridotta (era 50) */
    font-size: 11px !important;  /* Testo pi√π tecnico e piccolo */
    padding: 0 5px !important;   /* Meno ingombro laterale */
    flex: 1;                     /* Divisi equamente in larghezza */
    border-radius: 8px !important; /* Angoli leggermente meno arrotondati */
    letter-spacing: 0.5px;       /* Testo pi√π leggibile anche se piccolo */
}

/* Effetto quando sono disabilitati (pi√π trasparenti) */
.btn-toolbar button:disabled {
    opacity: 0.4 !important;
    cursor: not-allowed;
}

/* Rimpicciolisce i box delle date per farli stare sulla stessa riga su iPhone */
#tab-inventario .form-row {
    display: flex;
    gap: 10px;
    flex-wrap: nowrap !important; /* Forza i campi a stare affiancati */
}

#tab-inventario .form-group {
    flex: 1; 
    min-width: 0; /* Permette al campo di rimpicciolirsi quanto serve */
}

#filtro-data-dal, #filtro-data-al {
    padding: 0 5px !important; /* Toglie lo spazio interno inutile */
    font-size: 13px !important; /* Rimpicciolisce il testo della data */
    text-align: center;
}

textarea {
    box-sizing: border-box; /* Fa s√¨ che il padding non allarghi la textarea oltre il 100% */
    border: 1px solid #cbd5e1;
    transition: border-color 0.2s;
}

textarea:focus {
    outline: none;
    border-color: #3b82f6; /* Diventa blu quando ci scrivi dentro */
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(0,0,255,.1);
    border-radius: 50%;
    border-top-color: #007bff;
    animation: spin 1s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

</style>

</head>
<body>

<div class="container">
    <h1>Gestione SUK Valenza</h1>
    <input type="text" id="status-output" value="Inizializzazione..." readonly>

    <!-- Tab Buttons -->
    <div class="tabs">
        <button class="tab-button active" data-tab="tab-acquisti">Nuovo Acquisto</button>
        <button class="tab-button" data-tab="tab-gestione">Gestione Movimento</button>
        <button class="tab-button" data-tab="tab-inventario">Filtri / Riepilogo</button>
    </div>

    <!-- Tab Acquisti -->
<div id="tab-acquisti" class="tab-content active">
    <h2>Registra Nuovo Acquisto</h2>
    
    <div class="form-row">
        <div class="form-group">
            <label for="data-acquisto">Data Acquisto</label>
            <input type="date" id="data-acquisto">
        </div>
        <div class="form-group">
            <label for="articolo-acquisto">Articolo</label>
            <input type="text" id="articolo-acquisto" placeholder="Nome Articolo">
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="prezzo-acquisto">Prezzo Acquisto (‚Ç¨)</label>
            <input type="number" id="prezzo-acquisto" step="0.01">
        </div>
        <div class="form-group">
            <label for="guadagno-previsto">Guadagno Previsto (‚Ç¨)</label>
            <input type="number" id="guadagno-previsto" step="0.01">
        </div>
    </div>

<div class="form-group">
<label style="font-weight: bold; color: #004085;">ü§ñ Assistente AI </label>
            <div id="vinted-status-reg" style="font-size: 12px; color: #004085; margin-top: 5px; min-height: 20px; display: flex; align-items: center;"></div>
    
    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
        <div style="display: flex; gap: 10px;">
            <label style="flex: 1; background: #007bff; color: white; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                üì∏ Scatta
                <input type="file" accept="image/*" capture="environment" onchange="analizzaFotoConAI(this.files[0])" style="display:none;">
            </label>

            <label style="flex: 1; background: #6c757d; color: white; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                üñºÔ∏è Galleria
                <input type="file" accept="image/*" onchange="analizzaFotoConAI(this.files[0])" style="display:none;">
            </label>
        </div>

        <button onclick="resetCampiAI()" style="width: 100%; background: #dc3545; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">
            üóëÔ∏è Svuota Campi
        </button>
    </div>
</div>

<div style="margin-top: 30px; padding: 10px; border-top: 1px solid #ddd;">
    <label style="font-size: 10px; color: #888;">‚öôÔ∏è CONFIGURAZIONE AI (GEMINI)</label>
    <div style="display: flex; gap: 5px; margin-top: 5px;">
        <input type="password" id="input-api-key" placeholder="Incolla qui la chiave API..." style="flex: 1; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; padding: 5px;">
        <button onclick="salvaKey()" style="background: #444; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px;">SALVA</button>
    </div>
</div>

<script>
// Questa l'hai gi√† messa tu
function salvaKey() {
    const key = document.getElementById('input-api-key').value;
    if(key) {
        localStorage.setItem('mia_gemini_key', key);
        alert("Chiave salvata nel browser! Ora l'AI √® attiva.");
        document.getElementById('input-api-key').value = "";
    }
}

// INCOLLA QUESTA SUBITO SOTTO
async function analizzaFotoConAI(fileScelto) {
    if (!fileScelto) return;

    let API_KEY = localStorage.getItem('mia_gemini_key');
    if (API_KEY) API_KEY = API_KEY.trim();

    const status = document.getElementById('vinted-status-reg');
    if (!API_KEY) {
        alert("Inserisci la chiave API e clicca SALVA!");
        return;
    }

    // Attiva lo spinner
    status.innerHTML = `<div class="spinner"></div> <span style="margin-left:8px;">AI sta analizzando il capo...</span>`;

    const reader = new FileReader();
    reader.readAsDataURL(fileScelto);
    reader.onload = async () => {
        const base64Image = reader.result.split(',')[1];
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
    { text: "Analizza la foto per Vinted. Restituisci SOLO un JSON: 'titolo', 'prezzo_consigliato', 'descrizione'. Nella descrizione includi alla fine 10 hashtag pertinenti: 5 in italiano e 5 in inglese (es: #maglietta #tshirt). Non aggiungere altro testo fuori dal JSON." },
    { inline_data: { mime_type: "image/jpeg", data: base64Image } }
]
                    }]
                })
            });

            const result = await response.json();

            if (result.candidates && result.candidates[0].content.parts[0].text) {
                const textResponse = result.candidates[0].content.parts[0].text;
                const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
                
                if (jsonMatch) {
                    const data = JSON.parse(jsonMatch[0]);
                    
                    // Riempimento campi (Cerca entrambi gli ID possibili)
                    const fTitolo = document.getElementById('articolo') || document.getElementById('articolo-acquisto');
                    const fPrezzo = document.getElementById('guadagno-previsto');
                    const fDesc = document.getElementById('nota-acquisto');

                    if (fTitolo) fTitolo.value = data.titolo || "";
                    if (fPrezzo) fPrezzo.value = data.prezzo_consigliato || "";
                    if (fDesc) fDesc.value = data.descrizione || "";
                    
                    status.innerHTML = "‚úÖ <span style='color: green'>Analisi completata con Hashtag!</span>";
                }
            } else {
                status.innerHTML = "‚ùå <span style='color: red'>L'AI non ha capito la foto.</span>";
            }
        } catch (e) {
            status.innerHTML = "‚ùå <span style='color: red'>Errore di connessione.</span>";
        }
    };
}

function resetCampiAI() {
    if (confirm("Vuoi svuotare tutti i campi compilati dall'AI?")) {
        // Elenco di tutti gli ID dei campi da svuotare
        const campi = ['articolo', 'articolo-acquisto', 'guadagno-previsto', 'nota-acquisto'];
        
        campi.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) elemento.value = "";
        });

        // Resetta anche il messaggio di stato
        const status = document.getElementById('vinted-status-reg');
        if (status) status.innerText = "‚ú® Campi resettati.";
        
        console.log("Campi svuotati correttamente.");
    }
}   
</script>

    <div class="form-row">
        <div class="form-group" style="flex: 1;">
            <label for="nota-acquisto">Note Iniziali (Opzionale)</label>
            <textarea id="nota-acquisto" 
                      placeholder="Aggiungi dettagli extra..." 
                      style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 14px; margin-top: 5px; resize: vertical;"></textarea>
        </div>
    </div>
    <button id="btn-acquisto" class="btn-primary" style="margin-top: 15px;">Registra Acquisto</button>


        <div class="card" style="margin-top: 15px; padding: 0;">
    <button type="button" onclick="toggleChart()" style="width: 100%; background: none; border: none; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
        <span style="font-weight: bold; color: var(--color-primary);">üìä Visualizza Andamento Business</span>
        <span id="chart-arrow">‚ñº</span>
    </button>
    
    <div id="chart-container" style="display: none; padding: 0 15px 15px 15px;">
        <div style="height: 250px; position: relative;">
            <canvas id="businessChart"></canvas>
        </div>
    </div>
</div>


    </div>





    <!-- Tab Gestione -->
    <div id="tab-gestione" class="tab-content">
        <h2>Gestione Movimento Selezionato</h2>
        <p>Seleziona una riga da TAB "sezione riepilogo" per proseguire.</p>
        <div class="form-group">
            <label for="id-modifica">ID Movimento Selezionato</label>
            <input type="text" id="id-modifica" readonly>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="nuovo-articolo">Nuovo Articolo</label>
                <input type="text" id="nuovo-articolo">
            </div>
            <div class="form-group">
                <label for="nuovo-acquisto">Nuovo Prezzo Acquisto (‚Ç¨)</label>
                <input type="number" id="nuovo-acquisto" step="0.01">
            </div>
            <div class="form-group">
                <label for="prezzo-vendita">Prezzo Vendita (‚Ç¨)</label>
                <input type="number" id="prezzo-vendita" step="0.01">
            </div>

            <div class="form-group" style="margin-top: 15px;">
    <label for="nuova-nota">Note / Dettagli</label>
    <textarea id="nuova-nota" placeholder="Aggiungi dettagli extra..." rows="2" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 8px;"></textarea>
</div>
        </div>
<div class="btn-toolbar">
    <button id="btn-modifica" class="btn-secondary" disabled>‚úèÔ∏è MODIFICA</button>
    <button id="btn-vendita" class="btn-success" disabled>üí∞ VENDITA</button>
    <button id="btn-elimina" class="btn-danger" disabled>üóëÔ∏è ELIMINA</button>
</div>
    </div>

    <!-- Tab Inventario / Filtri -->
    <div id="tab-inventario" class="tab-content">
    <h2 style="margin-bottom: 10px;">Filtri e Riepilogo</h2>

    <div id="smart-insight" style="display: none; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; padding: 12px 16px; border-radius: 12px; margin-bottom: 20px; align-items: center; gap: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
        <div class="insight-icon" style="background: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            üí°
        </div>
        <div style="display: flex; flex-direction: column;">
            <small style="color: #1e40af; font-weight: bold; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.05em;">Consiglio Strategico</small>
            <span id="insight-text" style="font-size: 0.9rem; color: #1e3a8a; line-height: 1.4;"></span>
        </div>
    </div>

<div id="record-dashboard" style="display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto;">
    <div class="summary-box" onclick="mostraTop10()" style="flex: 1; min-width: 130px; border-top: 4px solid #f59e0b; background: #fffbeb; padding: 10px; border-radius: 8px; box-shadow: var(--shadow); cursor: pointer;">
    <small style="color: #92400e; font-weight: bold; font-size: 10px;">üèÜ TOP PROFITTO</small>
    <div id="top-profit" style="font-size: 1.1rem; font-weight: 800; color: #1e293b;">‚Ç¨0,00</div>
</div>
    
    <div class="summary-box" style="flex: 1; min-width: 130px; border-top: 4px solid #ec4899; background: #fdf2f8; padding: 10px; border-radius: 8px; box-shadow: var(--shadow);">
        <small style="color: #9d174d; font-weight: bold; font-size: 10px;">üìà MEDIA/PEZZO</small>
        <div id="media-profit" style="font-size: 1.1rem; font-weight: 800; color: #1e293b;">‚Ç¨0,00</div>
    </div>
</div>
    
    <div style="background: #fff; padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px;">
        <div class="form-row">
            <input type="hidden" id="tipo-filtro-data" value="data">
            <div class="form-group">
                <label for="filtro-stato">üè∑Ô∏è Stato:</label>
                <select id="filtro-stato">
                    <option value="Tutto">Tutto</option>
                    <option value="Acquistato">Disponibile</option>
                    <option value="Venduto">Venduto</option>
                    <option value="Giacenza">Giacenza (>14gg)</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="filtro-data-dal">Dal:</label>
                <input type="date" id="filtro-data-dal">
            </div>
            <div class="form-group">
                <label for="filtro-data-al">Al:</label>
                <input type="date" id="filtro-data-al">
            </div>
        </div>

            <div class="btn-toolbar" style="margin-top: 10px; display: flex; gap: 10px;">
                 <button id="btn-filtra" class="btn-primary" style="flex: 1;">Applica Filtri</button>
                 <button id="btn-reset-all" class="btn-secondary" style="flex: 1;">Reset</button>
                 <button id="btn-carica-tutto" class="btn-primary" style="flex: 1; background: #1e293b !important;">Tutto il DB</button>
            </div>
    </div>

    <div class="summary-container">
        <div class="summary-box" id="global-output"></div>
        <div class="summary-box" id="daily-output"></div>
    </div>

    <div class="form-group" style="margin-top: 15px;">
    <label for="search-articolo">üîç Cerca Articolo:</label>
    <input type="text" id="search-articolo" placeholder="Scrivi per filtrare la tabella..." style="border-color: var(--primary) !important;">
    </div>

<div class="card-table">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; margin-bottom: 15px;">
    <h3 style="margin: 0; font-size: 1.1rem; color: #1e293b; display: flex; align-items: center; gap: 8px;">
        üì¶ Lista Movimenti
    </h3>
    <span id="counter-movimenti" 
          style="background: #3730a3; 
                 color: #ffffff !important; 
                 padding: 4px 12px; 
                 border-radius: 8px; 
                 font-size: 14px; 
                 font-weight: 900; 
                 box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                 border: 1px solid #4338ca;">
        0
    </span>
</div>
    <div class="table-container">
        <table id="main-table">
            <thead>
                <tr>
                    <th style="display:none;">ID</th> 
                    <th style="width: 100px;">DATA ACQ.</th>
                    <th style="width: 130px;">STATO</th>
                    <th style="width: 100px;">DATA VEN.</th>
                    <th style="text-align: left; width: 300px;">ARTICOLO</th>
                    <th style="text-align: left; width: 120px;">NOTE</th>
                    <th style="width: 90px;">‚Ç¨ ACQ.</th>
                    <th style="width: 90px;">‚Ç¨ VEN.</th>
                    <th style="width: 100px;">PROFITTO</th>
                    <th style="width: 85px;">GIAC.</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

</div>

<script>
    // --- CONFIGURAZIONE SUPABASE ---
    const SUPABASE_URL = 'https://zyrlkjxxqzweetlkehrz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5cmxranh4cXp3ZWV0bGtlaHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NDg2OTEsImV4cCI6MjA3NzAyNDY5MX0.Gw23ftfgXfpZ_JKTz29txmLuIgnJCcuj8O1SMNh6qRc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- VARIABILI GLOBALI ---
// --- VARIABILI GLOBALI (Versione Finale) ---
    const tableBody = document.getElementById('table-body');
    const statusOutput = document.getElementById('status-output');
    const globalOutput = document.getElementById('global-output');
    const dailyOutput = document.getElementById('daily-output');
    
    // Bottoni
    const btnVendita = document.getElementById('btn-vendita');
    const btnModifica = document.getElementById('btn-modifica');
    const btnElimina = document.getElementById('btn-elimina');
    
    // Input Tab Gestione
    const idModificaInput = document.getElementById('id-modifica');
    const nuovoArticoloInput = document.getElementById('nuovo-articolo');
    const nuovoAcquistoInput = document.getElementById('nuovo-acquisto');
    const prezzoVenditaInput = document.getElementById('prezzo-vendita');
    const nuovaNotaInput = document.getElementById('nuova-nota'); 

    // Input Tab Acquisto
    const dataAcquistoInput = document.getElementById('data-acquisto'); // Ti serve per il default della data
    const articoloInput = document.getElementById('articolo-acquisto');
    const acquistoInput = document.getElementById('prezzo-acquisto');
    const guadagnoPrevistoInput = document.getElementById('guadagno-previsto'); // Aggiunto per comodit√†
    const notaAcquistoInput = document.getElementById('nota-acquisto'); 

    let selectedRowId = null;

    // --- OFFLINE QUEUE & DATA ---
    let offlineQueue = [];
    let movimentiGlobali = [];
    let myChart = null;
    let datiFiltratiCorrenti = [];
    const QUEUE_KEY = 'supabase_offline_queue';

let touchTimer;
function handleTouchStart(nome, note) {
    touchTimer = setTimeout(() => {
        openZoom(nome, note);
        if (navigator.vibrate) navigator.vibrate(50); // Vibrazione feedback
    }, 600); // 600ms = tempo del ditino premuto
}
function handleTouchEnd() {
    clearTimeout(touchTimer);
}
function openZoom(nome, note) {
    document.getElementById('zoom-nome').innerText = nome;
    document.getElementById('zoom-note').innerText = note;
    document.getElementById('modal-zoom').style.display = 'flex';
}

    function saveQueue(){ localStorage.setItem(QUEUE_KEY, JSON.stringify(offlineQueue)); updateOfflineStatus(); }
    function loadQueue(){ const storedQueue = localStorage.getItem(QUEUE_KEY); if(storedQueue){ offlineQueue = JSON.parse(storedQueue);} updateOfflineStatus(); }

    function updateOfflineStatus(){
        const count = offlineQueue.length;
        if(count>0){
            const connectionStatus = navigator.onLine ? 'Online' : 'Offline';
            setStatus(`‚ö†Ô∏è ${connectionStatus}: ${count} operazioni in attesa di sincronizzazione!`);
            document.body.style.border = '5px solid var(--color-warning)';
        } else {
            if(navigator.onLine){document.body.style.border='none'; setStatus("‚úÖ Dati caricati e sincronizzati.");} 
            else { setStatus("‚ùå Rete disconnessa. I dati mostrati non sono aggiornati."); document.body.style.border='5px solid var(--color-danger)';}
        }
    }

    async function attemptSync(){
        if(offlineQueue.length===0){ if(navigator.onLine) setStatus("‚úÖ Rete online. Nessuna operazione in attesa."); return;}
        if(!navigator.onLine) return;

        setStatus(`‚è≥ Rete online. Tentativo di sincronizzare ${offlineQueue.length} operazioni...`);
        let successfulSyncs = 0; let errors=0;
        const itemsToProcess = [...offlineQueue]; offlineQueue=[];

        for(const item of itemsToProcess){
            try{
                let result={error:{message:"Unknown error"}};
                if(item.action==='INSERT'){result=await supabaseClient.from('movimenti').insert([item.payload]).select();}
                else if(item.action==='UPDATE'){result=await supabaseClient.from('movimenti').update(item.payload).eq('id', item.id);}
                else if(item.action==='DELETE'){result=await supabaseClient.from('movimenti').delete().eq('id', item.id);}
                if(result && !result.error){successfulSyncs++;} else {errors++; offlineQueue.push(item); console.error(`Errore ${item.action} ID ${item.id}:`,result.error.message);}
            }catch(e){errors++; offlineQueue.push(item); console.error("Errore fetch:",e);}
        }
        saveQueue(); await refreshData();
        if(successfulSyncs>0){ setStatus(`‚úÖ Sincronizzazione completata: ${successfulSyncs} operazioni riuscite. ${errors} fallite.`);}
        else if(errors>0){ setStatus(`‚ùå Tentativo fallito. ${errors} operazioni rimaste in coda.`);}
    }

    function setStatus(message){ statusOutput.value=message; }

    function formatCurrency(value){ return `‚Ç¨${parseFloat(value||0).toFixed(2)}`; }

function setupTabs() {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            const targetTab = document.getElementById(btn.dataset.tab);
            if (targetTab) targetTab.classList.add('active');

            // Reset solo se il clic √® "reale" (fatto dall'utente col mouse/dito)
            // e non generato dal codice (isTrusted)
            if (e.isTrusted) {
                clearManagementFields();
            }
        });
    });
}
    
function clearManagementFields() {
    selectedRowId = null; 
    
    // Reset campi utilizzando le variabili globali dichiarate in alto
    if (idModificaInput) idModificaInput.value = ''; 
    if (nuovoArticoloInput) nuovoArticoloInput.value = ''; 
    if (nuovoAcquistoInput) nuovoAcquistoInput.value = ''; 
    if (prezzoVenditaInput) prezzoVenditaInput.value = ''; 
    
    // Reset Note (usando la variabile globale)
    if (nuovaNotaInput) nuovaNotaInput.value = ''; 
    
    // Reset stato
    if (statusOutput) statusOutput.value = "‚úÖ Pronto."; 

    // Rimuove l'evidenziazione dalla tabella
    document.querySelectorAll('.selected-row').forEach(row => row.classList.remove('selected-row'));
    
    // Aggiorna lo stato dei bottoni (li disabilita)
    updateManagementButtons();
}
    
function updateManagementButtons(){
        const isSelected = selectedRowId!==null && !isNaN(selectedRowId) && selectedRowId>0;
        btnVendita.disabled=!isSelected; btnModifica.disabled=!isSelected; btnElimina.disabled=!isSelected;
        const opacityValue = isSelected?'1':'0.7';
        btnVendita.style.opacity=opacityValue; btnModifica.style.opacity=opacityValue; btnElimina.style.opacity=opacityValue;
        if(!isSelected){ document.querySelectorAll('.selected-row').forEach(row=>row.classList.remove('selected-row'));}
}

    // --- CRUD FUNCTIONS ---
async function addAcquisto() {
    // Usiamo le variabili globali gi√† dichiarate per essere pi√π veloci
    const data = dataAcquistoInput.value || new Date().toISOString().split('T')[0];
    const articolo = articoloInput.value.trim();
    const prezzoAcquisto = parseFloat(acquistoInput.value);
    const guadagnoPrevisto = parseFloat(guadagnoPrevistoInput.value) || 0.0;
    const notaAcquisto = notaAcquistoInput.value.trim();

    if (!articolo || isNaN(prezzoAcquisto) || prezzoAcquisto <= 0) {
        setStatus("‚ö†Ô∏è Inserisci articolo e prezzo valido."); 
        return;
    }

    setStatus("‚è≥ Registrazione acquisto...");

    const newRow = { 
        data, 
        articolo, 
        acquisto: prezzoAcquisto, 
        vendita: 0.0, 
        guadagno_previsto: guadagnoPrevisto, 
        note: notaAcquisto, 
        stato: 'Acquistato' 
    };

    const { data: newData, error } = await supabaseClient.from('movimenti').insert([newRow]).select();

    if (error) {
        offlineQueue.push({ action: 'INSERT', payload: newRow });
        saveQueue();
        setStatus(`‚ö†Ô∏è Acquisto salvato offline. ${offlineQueue.length} in coda.`);
    } else {
        setStatus(`‚úÖ Acquisto registrato (ID ${newData[0].id})`);
        await refreshData();
        
        // RESET CAMPI usando le variabili globali
        articoloInput.value = '';
        acquistoInput.value = '';
        guadagnoPrevistoInput.value = '';
        notaAcquistoInput.value = ''; 
    }
}

async function updateMovimento(isVendita = false) {
    const idToEdit = selectedRowId;
    if (isNaN(idToEdit) || idToEdit <= 0) {
        setStatus("‚ö†Ô∏è Seleziona un ID valido dalla tabella.");
        return;
    }

    const updatePayload = {};
    const messages = [`ID ${idToEdit}:`];

    // --- 1. RECUPERO NOTE (Uso la variabile globale nuovaNotaInput) ---
    if (nuovaNotaInput) {
        updatePayload.note = nuovaNotaInput.value.trim();
        if (updatePayload.note) messages.push("üìù Note salvate");
    }

    // --- 2. LOGICA SPECIFICA PER LA VENDITA ---
    if (isVendita) {
        const prezzoVendita = parseFloat(prezzoVenditaInput.value);
        if (isNaN(prezzoVendita) || prezzoVendita <= 0) {
            setStatus("‚ö†Ô∏è Inserisci un prezzo di vendita valido!");
            return;
        }
        updatePayload.vendita = prezzoVendita;
        updatePayload.stato = 'Venduto';
        updatePayload.data_vendita = new Date().toISOString().split('T')[0]; 
        messages.push("üí∞ Vendita registrata");
    } 

    // --- 3. LOGICA PER MODIFICA ---
    if (nuovoArticoloInput.value.trim()) {
        updatePayload.articolo = nuovoArticoloInput.value.trim();
        messages.push("‚úèÔ∏è Articolo modificato");
    }
    if (nuovoAcquistoInput.value && !isNaN(parseFloat(nuovoAcquistoInput.value))) {
        updatePayload.acquisto = parseFloat(nuovoAcquistoInput.value);
        messages.push("üí∏ Prezzo acquisto aggiornato");
    }

    if (Object.keys(updatePayload).length === 0) {
        setStatus("‚ÑπÔ∏è Nessuna modifica inserita.");
        return;
    }

    setStatus("‚è≥ Aggiornamento database...");

    const { error } = await supabaseClient.from('movimenti').update(updatePayload).eq('id', idToEdit);

    if (error) {
        offlineQueue.push({ action: 'UPDATE', id: idToEdit, payload: updatePayload });
        saveQueue();
        setStatus(`‚ö†Ô∏è Errore rete. Salvato in coda offline.`);
        console.error("Errore Supabase:", error.message);
    } else {
        setStatus(messages.join(" ‚Ä¢ "));
        clearManagementFields(); 
        await refreshData(); 
    }
}

async function deleteMovimento(){
        const idToDelete=selectedRowId;
        if(isNaN(idToDelete)||idToDelete<=0){setStatus("‚ö†Ô∏è Seleziona un ID valido."); return;}
        if(!confirm(`Eliminare ID ${idToDelete}?`)) return;
        setStatus("‚è≥ Eliminazione...");
        const {error}=await supabaseClient.from('movimenti').delete().eq('id',idToDelete);
        if(error){ offlineQueue.push({action:'DELETE',id:idToDelete}); saveQueue(); setStatus("‚ö†Ô∏è Eliminazione salvata offline.");}
        else{setStatus(`üóëÔ∏è ID ${idToDelete} eliminato.`); clearManagementFields(); await refreshData();}
    }


async function loadDataAndRender() {
    const hiddenTipoData = document.getElementById('tipo-filtro-data');
    const filterStato = document.getElementById('filtro-stato').value;
    const dal = document.getElementById('filtro-data-dal').value;
    const al = document.getElementById('filtro-data-al').value;

    if (filterStato === 'Venduto') {
        hiddenTipoData.value = 'data_vendita'; 
    } else {
        hiddenTipoData.value = 'data'; 
    }

    const tipoData = hiddenTipoData.value;
    setStatus("‚è≥ Caricamento...");

    let query = supabaseClient.from('movimenti').select('*').order('id', {ascending: false});

    if (dal || al) {
        if (dal) query = query.gte(tipoData, dal);
        if (al) query = query.lte(tipoData, al);
        if (filterStato === 'Acquistato' || filterStato === 'Venduto') {
            query = query.eq('stato', filterStato);
        }
    } else {
        const annoCorrente = new Date().getFullYear();
        if (filterStato === 'Venduto') {
            query = query.eq('stato', 'Venduto').gte('data_vendita', `${annoCorrente}-01-01`);
        } else if (filterStato === 'Acquistato' || filterStato === 'Giacenza') {
            query = query.eq('stato', 'Acquistato');
        } else {
            query = query.or(`stato.eq.Acquistato,and(stato.eq.Venduto,data_vendita.gte.${annoCorrente}-01-01)`);
        }
    }

    const { data: movimenti, error } = await query;

    if (error) { 
        console.error("Errore Supabase:", error);
        setStatus("‚ùå Errore caricamento"); 
        return; 
    }
    
    movimentiGlobali = movimenti;

    const processedData = movimenti.map(mov => {
        const profitto = (mov.vendita || 0) - (mov.acquisto || 0);
        let giorniGiacenza = 0;
        const dataAcq = new Date(mov.data);
        
        if (mov.stato === 'Venduto' && mov.data_vendita) {
            const dataVen = new Date(mov.data_vendita);
            giorniGiacenza = Math.floor((dataVen - dataAcq) / (1000 * 60 * 60 * 24));
        } else if (mov.data) {
            const oggi = new Date();
            giorniGiacenza = Math.floor((oggi - dataAcq) / (1000 * 60 * 60 * 24));
        }

        if (giorniGiacenza < 0) giorniGiacenza = 0;
        const allertaGiacenza = (mov.stato === 'Acquistato' && giorniGiacenza > 14);

        return { 
            ...mov, 
            profitto, 
            giacenza: giorniGiacenza, 
            isAlert: allertaGiacenza 
        };
    });

    // --- PUNTO 5: FILTRO LOGICO EXTRA ---
    let finalData = processedData;
    if (filterStato === 'Giacenza') {
        // Filtriamo solo quelli che hanno l'allerta attivata (>14gg)
        finalData = processedData.filter(m => m.isAlert === true);
    }

    // --- PUNTO 6: RENDERING FINALE ---
    renderTable(finalData);
    calculateAndRenderSummaries(movimenti, finalData);
    
    // Controlla se il grafico esiste prima di aggiornarlo
    if (typeof updateChart === 'function') updateChart(movimenti);
    
    // üü¢ QUI ABBIAMO CORRETTO IL NOME DELLA VARIABILE
    updateRecords(finalData); 
    
    
    setStatus("‚úÖ Dati aggiornati.");
}


function renderTable(data) {
    const tbody = document.getElementById('table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    const f = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });

    data.forEach(mov => {
        const tr = document.createElement('tr');
        tr.dataset.id = mov.id; 

        // --- CALCOLO SICURO DEI VALORI ---
        const acq = parseFloat(mov.acquisto) || 0;
        const ven = parseFloat(mov.vendita) || 0;
        const prof = ven - acq;

        // --- LOGICA GIACENZA E ALERT ---
        const dataAcq = new Date(mov.data);
        const oggi = new Date();
        const giorniGiacenza = Math.floor((oggi - dataAcq) / (1000 * 60 * 60 * 24));
        const giorniMostrati = giorniGiacenza >= 0 ? giorniGiacenza : 0;
        const isAlertGiacenza = (mov.stato === 'Acquistato' && giorniMostrati > 14);

        // --- BADGE STATO ---
        let statoBadge = '';
        if (mov.stato === 'Venduto') {
            statoBadge = `<span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; border: 1px solid #bbf7d0;">VENDUTO</span>`;
        } else {
            const colorAcq = isAlertGiacenza ? '#991b1b' : '#3730a3'; 
            const bgAcq = isAlertGiacenza ? '#fee2e2' : '#e0e7ff';    
            const alertIcon = isAlertGiacenza ? '‚ö†Ô∏è ' : '';
            statoBadge = `<span style="background: ${bgAcq}; color: ${colorAcq}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; border: 1px solid ${colorAcq};">${alertIcon}DISPONIBILE</span>`;
        }

        const dataVenLabel = mov.data_vendita ? new Date(mov.data_vendita).toLocaleDateString('it-IT') : '-';
        
        // --- HTML GIACENZA ---
        const giacenzaHtml = mov.stato === 'Venduto' 
            ? `<span style="color: #94a3b8;">-</span>` 
            : (isAlertGiacenza 
                ? `<span style="color: #ef4444; font-weight: 800;">üî¥ ${giorniMostrati} gg</span>` 
                : `<span>${giorniMostrati} gg</span>`);

        // --- PREPARAZIONE TESTI PER ZOOM ---
        // Usiamo JSON.stringify per evitare che apici o caratteri speciali rompano l'HTML
        const artEscaped = (mov.articolo || '-').replace(/'/g, "\\'");
        const noteEscaped = (mov.note || 'Nessuna nota').replace(/'/g, "\\'");

        tr.innerHTML = `
            <td style="display:none;">${mov.id}</td>
            <td>${new Date(mov.data).toLocaleDateString('it-IT')}</td>
            <td>${statoBadge}</td>
            <td>${dataVenLabel}</td>
            
            <td class="zoomable" 
                style="text-align: left; font-weight: 700; cursor: zoom-in;"
                ontouchstart="handleTouchStart('${artEscaped}', '${noteEscaped}')" 
                ontouchend="handleTouchEnd()" 
                ontouchmove="handleTouchEnd()"
                onmousedown="handleTouchStart('${artEscaped}', '${noteEscaped}')" 
                onmouseup="handleTouchEnd()"
                onmouseleave="handleTouchEnd()">
                ${mov.articolo || '-'}
            </td>
            
            <td style="text-align: left; font-size: 0.8rem; color: #64748b; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${mov.note || '-'}
            </td>

            <td>${f.format(acq)}</td>
            <td>${mov.vendita ? f.format(ven) : '-'}</td>
            <td class="${prof >= 0 ? 'profit-positive' : 'profit-negative'}">
                ${mov.stato === 'Venduto' ? f.format(prof) : '-'}
            </td>
            <td>${giacenzaHtml}</td>
        `;
        tbody.appendChild(tr);
    });

    const counter = document.getElementById('counter-movimenti');
    if (counter) counter.textContent = data.length;
    calcolaEVisualizzaInsight();
}

async function calculateAndRenderSummaries(globalData,filteredData){
        let tot_a=globalData.reduce((sum,i)=>sum+(i.acquisto||0),0);
        let tot_v=globalData.reduce((sum,i)=>sum+(i.vendita||0),0);
        let profit=tot_v-tot_a;
        globalOutput.innerHTML=`<h3>Totale Generale</h3><p>Acquisti: ${formatCurrency(tot_a)}</p><p>Vendite: ${formatCurrency(tot_v)}</p><p>Profitto: <span class="${profit>=0?'profit-positive':'profit-negative'}">${formatCurrency(profit)}</span></p>`;
        let da=filteredData.reduce((s,i)=>s+(i.acquisto||0),0);
        let dv=filteredData.reduce((s,i)=>s+(i.vendita||0),0);
        let dp=dv-da;
        dailyOutput.innerHTML=`<h3>Riepilogo Filtri</h3><p>Acquisti: ${formatCurrency(da)} | Vendite: ${formatCurrency(dv)}</p><p>Profitto: <span class="${dp>=0?'profit-positive':'profit-negative'}">${formatCurrency(dp)}</span></p>`;
    }

async function refreshData(){ 
    // Prendiamo i valori dai nuovi ID che hai nell'HTML
    const dal = document.getElementById('filtro-data-dal').value;
    const stato = document.getElementById('filtro-stato').value;
    await loadDataAndRender(); 
}

async function resetAll(){ 
    document.getElementById('filtro-data-dal').value = ''; 
    document.getElementById('filtro-data-al').value = ''; 
    document.getElementById('filtro-stato').value = 'Tutto'; 
    document.getElementById('search-articolo').value = '';
    
    // PULISCE ANCHE LA SEZIONE MODIFICA/VENDITA
    clearManagementFields(); 

    await loadDataAndRender(); 
}

// --- FUNZIONE PER RICHIAMARE TUTTO IL DB ---
document.getElementById('btn-carica-tutto')?.addEventListener('click', async () => {
    setStatus("‚è≥ Caricamento totale in corso...");
    
    // Reset filtri visivi per coerenza
    document.getElementById('filtro-data-dal').value = '';
    document.getElementById('filtro-data-al').value = '';
    document.getElementById('filtro-stato').value = 'Tutto';
    document.getElementById('search-articolo').value = '';

    const { data, error } = await supabaseClient
        .from('movimenti')
        .select('*')
        .order('id', { ascending: false });

    if (error) {
        setStatus("‚ùå Errore nel richiamo dei dati.");
        console.error(error);
        return;
    }

    movimentiGlobali = data;

    const processed = data.map(mov => {
        const profitto = (mov.vendita || 0) - (mov.acquisto || 0);
        const dataAcq = new Date(mov.data);
        const oggi = new Date();
        const giorni = Math.floor((oggi - dataAcq) / (1000 * 60 * 60 * 24));
        const isAlert = (mov.stato === 'Acquistato' && giorni > 14);
        return { ...mov, profitto, giacenza: giorni >= 0 ? giorni : 0, isAlert };
    });

    renderTable(processed);
    calculateAndRenderSummaries(data, processed);
    if(myChart) updateChart(data);
    updateRecords(data);
    
    setStatus(`‚úÖ Visualizzati tutti i ${data.length} movimenti.`);
});

// grafico
function toggleChart() {
    const container = document.getElementById('chart-container');
    const arrow = document.getElementById('chart-arrow');
    
    if (container.style.display === "none") {
        container.style.display = "block";
        arrow.textContent = "‚ñ≤";
        // Forza il refresh del grafico per adattarsi allo spazio appena aperto
        if (myChart) myChart.resize();
    } else {
        container.style.display = "none";
        arrow.textContent = "‚ñº";
    }
}

function updateChart(movimenti) {
    const canvas = document.getElementById('businessChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // 1. Ordiniamo i movimenti per data (dal pi√π vecchio al pi√π recente)
    const datiOrdinati = [...movimenti].sort((a, b) => new Date(a.data) - new Date(b.data));

    // 2. Raggruppiamo per Mese-Anno (es: "12-2025", "01-2026") per non avere troppi punti
    const raggruppati = {};

    datiOrdinati.forEach(m => {
        // Le uscite le contiamo quando hai comprato
        const dAcq = new Date(m.data);
        const labelAcq = `${dAcq.getMonth() + 1}/${dAcq.getFullYear()}`;
        if (!raggruppati[labelAcq]) raggruppati[labelAcq] = { acquisti: 0, vendite: 0 };
        raggruppati[labelAcq].acquisti += (m.acquisto || 0);
        
        // Le entrate le contiamo quando hai effettivamente venduto
        if (m.stato === 'Venduto' && m.data_vendita) {
            const dVen = new Date(m.data_vendita);
            const labelVen = `${dVen.getMonth() + 1}/${dVen.getFullYear()}`;
            if (!raggruppati[labelVen]) raggruppati[labelVen] = { acquisti: 0, vendite: 0 };
            raggruppati[labelVen].vendite += (m.vendita || 0);
        }
    });

    const labels = Object.keys(raggruppati);
    const dataAcquisti = labels.map(l => raggruppati[l].acquisti);
    const dataVendite = labels.map(l => raggruppati[l].vendite);

    if (myChart) myChart.destroy();

    myChart = new Chart(ctx, {
        type: 'line', // La linea √® meglio per vedere l'andamento nel tempo
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Uscite (Acquisti)',
                    data: dataAcquisti,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.3 // Rende la linea curva e "morbida"
                },
                {
                    label: 'Entrate (Vendite)',
                    data: dataVendite,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { callback: v => '‚Ç¨' + v }
                }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}


function updateRecords(data) {
    const venduti = data.filter(m => m.stato === 'Venduto');
    const f = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });

    if (venduti.length === 0) {
        document.getElementById('top-profit').textContent = f.format(0);
        document.getElementById('media-profit').textContent = f.format(0);
        return;
    }

    // Calcolo del profitto pi√π alto mai fatto su un singolo pezzo
    let maxP = 0;
    venduti.forEach(m => {
        const p = (parseFloat(m.vendita) || 0) - (parseFloat(m.acquisto) || 0);
        if (p > maxP) maxP = p;
    });

    // Calcolo della media
    const totaleP = venduti.reduce((acc, m) => acc + ((parseFloat(m.vendita) || 0) - (parseFloat(m.acquisto) || 0)), 0);
    const media = totaleP / venduti.length;

    document.getElementById('top-profit').textContent = f.format(maxP);
    document.getElementById('media-profit').textContent = f.format(media);
}



function mostraTop10() {
    const f = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });
    
    // 1. Legge cosa hai scritto nella barra
    const testoCercato = document.getElementById('search-articolo').value.toLowerCase();
    
    // 2. Filtra i dati: devono essere VENDUTI e devono contenere il TESTO CERCATO
    const classifica = movimentiGlobali
        .filter(m => {
            const nome = (m.articolo || "").toLowerCase();
            const eStatoVenduto = m.stato === 'Venduto';
            // Se hai scritto qualcosa, filtra per nome. Se la barra √® vuota, passa tutto.
            const matchesTesto = testoCercato ? nome.includes(testoCercato) : true;
            return eStatoVenduto && matchesTesto;
        })
        // 3. Ordina dal profitto pi√π alto al pi√π basso
        .sort((a, b) => {
            const profA = (parseFloat(a.vendita) || 0) - (parseFloat(a.acquisto) || 0);
            const profB = (parseFloat(b.vendita) || 0) - (parseFloat(b.acquisto) || 0);
            return profB - profA;
        })
        // 4. Prendi i primi 10
        .slice(0, 10);

    // 5. Genera l'HTML
    let html = "";
    if (classifica.length === 0) {
        html = `<p style="text-align:center; padding:20px; color:#64748b;">Nessuna giacca venduta trovata.</p>`;
    } else {
        classifica.forEach((m, i) => {
            const prof = (parseFloat(m.vendita) || 0) - (parseFloat(m.acquisto) || 0);
            html += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #f1f5f9;">
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-size:0.9rem;">${i+1}. <b>${m.articolo}</b></span>
                        <small style="color:#94a3b8; font-size:0.7rem;">${new Date(m.data_vendita).toLocaleDateString('it-IT')}</small>
                    </div>
                    <span style="color:#166534; font-weight:bold; background:#dcfce7; padding:2px 8px; border-radius:6px; font-size:0.85rem;">+${f.format(prof)}</span>
                </div>`;
        });
    }

    document.getElementById('lista-top-10').innerHTML = html;
    document.getElementById('modal-top-10').style.display = 'flex';
}


function calcolaEVisualizzaInsight() {
    if (!movimentiGlobali || movimentiGlobali.length === 0) return;

    const conteggioGiorni = new Array(7).fill(0);
    const conteggioMesi = new Array(12).fill(0);
    const reportDinamico = {}; // Qui nasceranno le categorie da sole!

    const venduti = movimentiGlobali.filter(m => m.stato === 'Venduto' && m.data_vendita);
    if (venduti.length === 0) return;

    venduti.forEach(m => {
        // 1. Tempo (Giorno e Mese)
        const data = new Date(m.data_vendita);
        if (!isNaN(data.getTime())) {
            conteggioGiorni[data.getDay()]++;
            conteggioMesi[data.getMonth()]++;
        }

        // 2. Categoria Dinamica (Prendiamo la prima parola)
        // Puliamo la stringa, prendiamo la prima parola e la mettiamo in maiuscolo
        const nomeCompleto = (m.articolo || "").trim();
        if (nomeCompleto) {
            const primaParola = nomeCompleto.split(' ')[0].toUpperCase();
            // Escludiamo parole troppo corte tipo "IL", "LA", "UN"
            if (primaParola.length > 2) {
                reportDinamico[primaParola] = (reportDinamico[primaParola] || 0) + 1;
            }
        }
    });

    // Calcolo Vincitori
    const giorni = ["Domenica", "Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨", "Sabato"];
    const mesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
    
    const migliorGiorno = giorni[conteggioGiorni.indexOf(Math.max(...conteggioGiorni))];
    const migliorMese = mesi[conteggioMesi.indexOf(Math.max(...conteggioMesi))];

    // Trova la categoria pi√π venduta tra quelle nate dinamicamente
    let trendDinamico = "Nessun dato";
    let maxVoti = 0;
    for (const [cat, voti] of Object.entries(reportDinamico)) {
        if (voti > maxVoti) {
            maxVoti = voti;
            trendDinamico = cat;
        }
    }

    const insightBox = document.getElementById('smart-insight');
    const insightText = document.getElementById('insight-text');
    
    if (insightBox && insightText) {
        insightText.innerHTML = `
            üöÄ <b>Trend:</b> Stai vendendo forte la categoria <b>${trendDinamico}</b>.<br>
            üìÖ <b>Timing:</b> Il tuo giorno d'oro √® il <b>${migliorGiorno}</b>.<br>
            üèÜ <b>Stagionalit√†:</b> <b>${migliorMese}</b> √® il mese con pi√π volume.
        `;
        insightBox.style.display = 'flex';
    }
}





// Funzione di supporto per leggere il file
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});
    // --- EVENT LISTENERS ---
 document.addEventListener('DOMContentLoaded', () => {
    // Imposta data odierna di default
    const dataAcquistoInput = document.getElementById('data-acquisto');
    if (dataAcquistoInput) dataAcquistoInput.value = new Date().toISOString().split('T')[0];

    // Inizializzazioni
    setupTabs();
    loadQueue();
    loadDataAndRender();
    updateManagementButtons();

    // Eventi di rete e bottoni
    window.addEventListener('online', attemptSync);
    document.getElementById('btn-acquisto').addEventListener('click', addAcquisto);
    document.getElementById('btn-modifica').addEventListener('click', () => updateMovimento(false));
    document.getElementById('btn-vendita').addEventListener('click', () => updateMovimento(true));
    document.getElementById('btn-elimina').addEventListener('click', deleteMovimento);
    document.getElementById('btn-filtra').addEventListener('click', refreshData);
    document.getElementById('btn-reset-all').addEventListener('click', resetAll);

    // --- LISTENER TABELLA MIGLIORATO ---
    tableBody.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row) return;

        const currentId = parseInt(row.dataset.id);
        if (!currentId) return;

        // Se clicchi sulla riga gi√† selezionata, deseleziona
        if (selectedRowId === currentId) {
            row.classList.remove('selected-row');
            clearManagementFields();
            return;
        }

        // Rimuovi selezione precedente
        document.querySelectorAll('.selected-row').forEach(r => r.classList.remove('selected-row'));
        
        // Nuova selezione
        selectedRowId = currentId;
        row.classList.add('selected-row');

        // --- RECUPERO DATI DALLE CELLE CON INDICI NUOVI ---
        // 4 = Articolo
        // 5 = NOTE (Nuova!)
        // 6 = Prezzo Acquisto
        // 7 = Prezzo Vendita
        const articolo = row.cells[4].innerText;
        const notaDallaTabella = row.cells[5].innerText === '-' ? '' : row.cells[5].innerText;
        
        // Pulizia Prezzo Acquisto (Indice 6)
        let rawAcquisto = row.cells[6].innerText.replace('‚Ç¨', '').replace(/\./g, '').replace(',', '.').trim();
        
        // Pulizia Prezzo Vendita (Indice 7)
        let rawVendita = row.cells[7].innerText.replace('‚Ç¨', '').replace(/\./g, '').replace(',', '.').trim();

        // --- RIEMPIMENTO CAMPI ---
        idModificaInput.value = currentId;
        nuovoArticoloInput.value = articolo;
        
        // Se hai aggiunto la textarea con id "nuova-nota", la riempiamo
        const textareaNota = document.getElementById('nuova-nota');
        if (textareaNota) textareaNota.value = notaDallaTabella;

        nuovoAcquistoInput.value = parseFloat(rawAcquisto) || 0;
        prezzoVenditaInput.value = (rawVendita === '-' || isNaN(parseFloat(rawVendita))) ? '' : rawVendita;

        setStatus(`‚ÑπÔ∏è ID ${selectedRowId} pronto.`);
        updateManagementButtons();

        // Switch al tab gestione
        const tabGestione = document.querySelector('.tab-button[data-tab="tab-gestione"]');
        if (tabGestione) tabGestione.click();
    });
});

//filtro testuale
// 2. Modifica il listener della ricerca cos√¨:
document.getElementById('search-articolo').addEventListener('input', function(e) {
    const searchText = e.target.value.toLowerCase();
    
    const filtrati = movimentiGlobali.filter(mov => {
        const nomeArticolo = (mov.articolo || '').toLowerCase();
        return nomeArticolo.includes(searchText);
    });

    // SISTEMATO: Usiamo lo stesso nome che hai dichiarato sopra
    datiFiltratiCorrenti = filtrati; 

    renderTable(filtrati);
    calculateAndRenderSummaries(movimentiGlobali, filtrati);
    updateRecords(filtrati);
});

// 1. Il tuo codice esistente per il click
document.getElementById('btn-acquisto').addEventListener('click', () => {
    // Qui andrebbe la tua logica di salvataggio...
    setTimeout(() => document.getElementById('articolo-acquisto').focus(), 500);
});

// 2. AGGIUNGI QUESTO: permette di salvare premendo "Invio" sulla tastiera
document.getElementById('prezzo-acquisto').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        document.getElementById('btn-acquisto').click();
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const desc = document.getElementById('nota-acquisto');
    if (desc) {
        desc.addEventListener('click', function() {
            if (this.value.trim() === "") return;
            this.select();
            navigator.clipboard.writeText(this.value);
            document.getElementById('vinted-status-reg').innerText = "üìã Copiato!";
            this.style.backgroundColor = "#e8f5e9";
            setTimeout(() => this.style.backgroundColor = "", 500);
        });
    }
});

    // --- SERVICE WORKER ---
    if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('/mercatino/sw.js').then(reg=>console.log('‚úÖ SW registrato',reg.scope)).catch(err=>console.error('‚ùå SW fallito',err));}); }

    // --- PWA INSTALL PROMPT ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e;
        const installBtn=document.createElement('button');
        installBtn.textContent='üì≤ Installa App';
        installBtn.style.position='fixed'; installBtn.style.bottom='20px'; installBtn.style.right='20px'; installBtn.style.padding='10px 15px'; installBtn.style.background='#4f46e5'; installBtn.style.color='white'; installBtn.style.border='none'; installBtn.style.borderRadius='8px'; installBtn.style.cursor='pointer';
        document.body.appendChild(installBtn);
        installBtn.addEventListener('click',async()=>{
            installBtn.remove(); deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; console.log('Installazione:',outcome); deferredPrompt=null;
        });
    });
    window.addEventListener('appinstalled',()=>{ console.log('‚úÖ App installata con successo!'); });


</script>



<div id="modal-top-10" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; justify-content:center; align-items:center; backdrop-filter: blur(4px);">
    <div style="background:white; width:92%; max-width:400px; border-radius:15px; padding:20px; position:relative; box-shadow: 0 20px 25px rgba(0,0,0,0.2);">
        <button onclick="document.getElementById('modal-top-10').style.display='none'" style="position:absolute; top:12px; right:15px; border:none; background:#eee; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center;">&times;</button>
        
        <h3 style="margin-top:0; color:#1e293b; font-size: 1.3rem; margin-bottom: 5px;">üèÜ Top 10 Risultati</h3>
        <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 15px;">Basato sui filtri attuali</p>
        
        <div id="lista-top-10" style="max-height: 60vh; overflow-y: auto; padding-right: 5px; border-top: 1px solid #f1f5f9;">
            </div>
    </div>
</div>

<div id="modal-zoom" onclick="this.style.display='none'" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(4px);">
    <div style="background:white; width:90%; max-width:400px; border-radius:20px; padding:25px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="zoom-nome" style="margin:0; color:#4f46e5; font-size:1.4rem;"></h3>
            <span onclick="document.getElementById('modal-zoom').style.display='none'" style="font-size:28px; cursor:pointer; color:#94a3b8;">&times;</span>
        </div>
        <label style="font-size:11px; font-weight:800; color:#64748b; text-transform:uppercase;">Note / Dettagli</label>
        <p id="zoom-note" style="white-space:pre-wrap; background:#f1f5f9; padding:15px; border-radius:12px; color:#1e293b; margin-top:5px; line-height:1.5; border:1px solid #e2e8f0;"></p>
        <button onclick="document.getElementById('modal-zoom').style.display='none'" class="btn-primary" style="width:100%; margin-top:20px; height:50px !important; border-radius:12px !important;">CHIUDI</button>
    </div>
</div>

</body>
</html>
