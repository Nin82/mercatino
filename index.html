<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Inventario PWA</title>
<link rel="manifest" href="manifest.json">
<style>
:root {
    --color-primary: #007bff;
    --color-secondary: #6c757d;
    --color-success: #28a745;
    --color-warning: #ffc107;
    --color-danger: #dc3545;
    --color-background: #f8f9fa;
    --color-surface: #ffffff;
    --color-text: #212529;
    --border-radius: 8px;
    --shadow: 0 2px 4px rgba(0,0,0,0.1);
}

body, html {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    font-family: Arial, sans-serif;
    background-color: var(--color-background);
    color: var(--color-text);
}

.container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
    background-color: var(--color-surface);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
}

h1 { text-align: center; color: var(--color-primary); }

/* Tab system */
.tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 10px; }
.tab-button {
    padding: 10px 15px; cursor: pointer; border: none; background: transparent;
    font-weight: bold; color: var(--color-secondary);
}
.tab-button.active { color: var(--color-primary); border-bottom: 3px solid var(--color-primary); }
.tab-content { display: none; padding: 10px 0; }
.tab-content.active { display: block; }

/* Form & inputs */
.form-group { margin-bottom: 10px; }
.form-group input, .form-group select {
    width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box;
}
.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }

button { padding: 8px 12px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; }
button:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary { background-color: var(--color-primary); color: #fff; }
.btn-success { background-color: var(--color-success); color: #fff; }
.btn-danger { background-color: var(--color-danger); color: #fff; }
.btn-secondary { background-color: var(--color-secondary); color: #fff; }
.btn-toolbar { display: flex; gap: 10px; margin-top: 10px; }

/* Table */
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
th { background-color: var(--color-primary); color: white; }
tr:nth-child(even) { background-color: #f2f2f2; }
tr:hover { background-color: #ddd; }
.selected-row { background-color: var(--color-warning) !important; }

/* Status & summaries */
#status-output { width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid var(--color-secondary); background: #eee; }
.summary-box { padding: 10px; background: #e9ecef; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-top: 10px; }
.summary-value { font-weight: bold; }
.profit-positive { color: var(--color-success); font-weight: bold; }
.profit-negative { color: var(--color-danger); font-weight: bold; }
</style>
</head>
<body>

<div class="container">
<h1>Gestione Inventario PWA</h1>

<input type="text" id="status-output" value="Inizializzazione..." readonly>

<div class="tabs">
<button class="tab-button active" data-tab="tab-lista">Lista Movimenti</button>
<button class="tab-button" data-tab="tab-acquisti">Nuovo Acquisto</button>
<button class="tab-button" data-tab="tab-gestione">Modifica / Vendita / Elimina</button>
<button class="tab-button" data-tab="tab-inventario">Filtri & Riepilogo</button>
</div>

<!-- LISTA MOVIMENTI SEMPRE VISIBILE -->
<div id="tab-lista" class="tab-content active">
<h2>Movimenti Registrati</h2>
<table>
<thead>
<tr>
<th>ID</th><th>Data</th><th>Articolo</th><th>Acquisto</th><th>Vendita</th><th>Guadagno Previsto</th><th>Stato</th><th>Profitto Netto</th><th>‚ö†Ô∏è Attenzione</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>
</div>

<!-- ACQUISTO -->
<div id="tab-acquisti" class="tab-content">
<h2>Registra Nuovo Acquisto</h2>
<div class="form-row">
<div class="form-group"><label for="data-acquisto">Data Acquisto</label><input type="date" id="data-acquisto"></div>
<div class="form-group"><label for="articolo-acquisto">Articolo</label><input type="text" id="articolo-acquisto" placeholder="Nome Articolo"></div>
</div>
<div class="form-row">
<div class="form-group"><label for="prezzo-acquisto">Prezzo Acquisto (‚Ç¨)</label><input type="number" id="prezzo-acquisto" step="0.01" placeholder="0.00"></div>
<div class="form-group"><label for="guadagno-previsto">Guadagno Previsto (‚Ç¨)</label><input type="number" id="guadagno-previsto" step="0.01" placeholder="0.00"></div>
</div>
<button id="btn-acquisto" class="btn-primary">Registra Acquisto</button>
</div>

<!-- MODIFICA / VENDITA / ELIMINA -->
<div id="tab-gestione" class="tab-content">
<h2>Gestione Movimento Selezionato</h2>
<div class="form-group"><label for="id-modifica">ID Movimento Selezionato</label><input type="text" id="id-modifica" readonly></div>
<div class="form-row">
<div class="form-group"><label for="nuovo-articolo">Nuovo Articolo</label><input type="text" id="nuovo-articolo"></div>
<div class="form-group"><label for="nuovo-acquisto">Nuovo Prezzo Acquisto (‚Ç¨)</label><input type="number" id="nuovo-acquisto" step="0.01"></div>
<div class="form-group"><label for="prezzo-vendita">Prezzo Vendita (‚Ç¨)</label><input type="number" id="prezzo-vendita" step="0.01"></div>
</div>
<div class="btn-toolbar">
<button id="btn-modifica" class="btn-secondary" disabled>Modifica Dati</button>
<button id="btn-vendita" class="btn-success" disabled>Registra Vendita</button>
<button id="btn-elimina" class="btn-danger" disabled>Elimina Movimento</button>
</div>
</div>

<!-- FILTRI & RIEPILOGO -->
<div id="tab-inventario" class="tab-content">
<h2>Filtri & Riepilogo</h2>
<div class="form-row">
<div class="form-group"><label for="filtro-data">Filtra per Data</label><input type="date" id="filtro-data"></div>
<div class="form-group"><label for="filtro-stato">Filtra per Stato</label>
<select id="filtro-stato">
<option value="Tutto">Tutto</option>
<option value="Acquistato">Acquistato</option>
<option value="Venduto">Venduto</option>
<option value="Giacenza">Giacenza</option>
</select>
</div>
</div>
<div class="btn-toolbar">
<button id="btn-filtra" class="btn-primary">Applica Filtri</button>
<button id="btn-reset-all" class="btn-secondary">Reset Filtri</button>
</div>
<div class="summary-box" id="global-output"></div>
<div class="summary-box" id="daily-output"></div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ========== CONFIG SUPABASE ==========
const SUPABASE_URL = 'https://zyrlkjxxqzweetlkehrz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5cmxranh4cXp3ZWV0bGtlaHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NDg2OTEsImV4cCI6MjA3NzAyNDY5MX0.Gw23ftfgXfpZ_JKTz29txmLuIgnJCcuj8O1SMNh6qRc';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ============================================
// LOGICA OFFLINE / BACKGROUND SYNC
// ============================================
let offlineQueue = [];
const QUEUE_KEY = 'supabase_offline_queue';

// SERVICE WORKER
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/mercatino/sw.js')
      .then(reg => console.log('‚úÖ SW registrato:', reg.scope))
      .catch(err => console.error('‚ùå SW fallito:', err));
  });
}

// ================== TODO: RESTO DEL CODICE CRUD, TAB, FILTRI E SYNC ==================
// Include tutte le funzioni addAcquisto(), updateMovimento(), deleteMovimento(),
// refreshData(), renderTable(), calculateAndRenderSummaries(),
// gestione selezione riga e pulsanti come nel tuo script originale.

</script>

<script>
// PWA INSTALL PROMPT
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const installBtn = document.createElement('button');
  installBtn.textContent = 'üì≤ Installa App';
  installBtn.style.position = 'fixed';
  installBtn.style.bottom = '20px';
  installBtn.style.right = '20px';
  installBtn.style.padding = '10px 15px';
  installBtn.style.background = '#4f46e5';
  installBtn.style.color = 'white';
  installBtn.style.border = 'none';
  installBtn.style.borderRadius = '8px';
  installBtn.style.cursor = 'pointer';
  document.body.appendChild(installBtn);

  installBtn.addEventListener('click', async () => {
    installBtn.remove();
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log('Installazione:', outcome);
    deferredPrompt = null;
  });
});

window.addEventListener('appinstalled', () => {
  console.log('‚úÖ App installata con successo!');
});
</script>

</body>
</html>
