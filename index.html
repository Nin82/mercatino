<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Magazzino</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --primary: #4f46e5;
  --success: #16a34a;
  --danger: #dc2626;
  --warning: #f59e0b;
  --surface: #fff;
  --bg: #f8fafc;
}
body {
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: #111;
  margin: 0;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 10px;
}
.container {
  width: 100%;
  max-width: 1200px;
  background: var(--surface);
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,.1);
  overflow: hidden;
  padding: 20px;
}
h1 { text-align: center; color: var(--primary); margin-top: 0; }

.tabs { display: flex; margin-bottom: 10px; }
.tab-button {
  flex: 1;
  background: none;
  border: none;
  padding: 10px;
  font-weight: bold;
  cursor: pointer;
  color: #555;
  border-bottom: 3px solid transparent;
}
.tab-button.active {
  color: var(--primary);
  border-color: var(--primary);
}
.tab-content { display: none; }
.tab-content.active { display: block; }

form input, form select {
  width: 100%; padding: 8px;
  border: 1px solid #ccc; border-radius: 6px;
  margin-bottom: 8px;
}
button {
  border: none; border-radius: 6px;
  padding: 10px 15px; color: white;
  cursor: pointer; font-weight: bold;
  margin-right: 5px; margin-top: 5px;
}
.btn-primary { background: var(--primary); }
.btn-success { background: var(--success); }
.btn-danger { background: var(--danger); }
.btn-warning { background: var(--warning); color: black; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
th { background: var(--primary); color: white; }
tr.selected-row { background: #e0e7ff; }

@media (max-width: 768px) {
  table, thead, tbody, th, td, tr { display: block; }
  th { display: none; }
  td { border: none; border-bottom: 1px solid #eee; }
}
</style>
</head>
<body>
<div class="container">
  <h1>üì¶ Gestione Magazzino</h1>
  <input type="text" id="status-output" readonly style="width:100%;margin-bottom:10px;">

  <div class="tabs">
    <button class="tab-button active" data-tab="tab-acquisti">Acquisti</button>
    <button class="tab-button" data-tab="tab-gestione">Gestione</button>
    <button class="tab-button" data-tab="tab-lista">Lista</button>
  </div>

  <!-- TAB: ACQUISTI -->
  <div id="tab-acquisti" class="tab-content active">
    <h3>‚ûï Registra Acquisto</h3>
    <form>
      <label>Data</label>
      <input type="date" id="data-acquisto">
      <label>Articolo</label>
      <input type="text" id="articolo-acquisto">
      <label>Prezzo (‚Ç¨)</label>
      <input type="number" id="prezzo-acquisto" step="0.01">
      <label>Guadagno Previsto (‚Ç¨)</label>
      <input type="number" id="guadagno-previsto" step="0.01">
      <button type="button" id="btn-acquisto" class="btn-primary">üíæ Salva Acquisto</button>
    </form>
  </div>

  <!-- TAB: GESTIONE -->
  <div id="tab-gestione" class="tab-content">
    <h3>üßæ Gestione Movimento</h3>
    <label>ID Movimento</label>
    <input type="text" id="id-modifica" readonly>
    <label>Articolo</label>
    <input type="text" id="nuovo-articolo">
    <label>Prezzo Acquisto (‚Ç¨)</label>
    <input type="number" id="nuovo-acquisto" step="0.01">
    <label>Prezzo Vendita (‚Ç¨)</label>
    <input type="number" id="prezzo-vendita" step="0.01">
    <div>
      <button id="btn-modifica" class="btn-warning">‚úèÔ∏è Modifica</button>
      <button id="btn-vendita" class="btn-success">üí∞ Registra Vendita</button>
      <button id="btn-elimina" class="btn-danger">üóëÔ∏è Elimina</button>
    </div>
  </div>

  <!-- TAB: LISTA -->
  <div id="tab-lista" class="tab-content">
    <h3>üìã Movimenti</h3>
    <div>
      <label>Data:</label><input type="date" id="filtro-data">
      <label>Stato:</label>
      <select id="filtro-stato">
        <option>Tutto</option>
        <option>Acquistato</option>
        <option>Venduto</option>
        <option>Giacenza</option>
      </select>
      <button id="btn-filtra" class="btn-primary">üîç Filtra</button>
      <button id="btn-reset-all" class="btn-warning">‚ôªÔ∏è Reset</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Data</th><th>Articolo</th>
          <th>Acquisto</th><th>Vendita</th><th>Guadagno</th><th>Stato</th><th>Profitto</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
</div>

<script>
/* === CONFIG SUPABASE === */
const SUPABASE_URL = 'https://zyrlkjxxqzweetlkehrz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5cmxranh4cXp3ZWV0bGtlaHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NDg2OTEsImV4cCI6MjA3NzAyNDY5MX0.Gw23ftfgXfpZ_JKTz29txmLuIgnJCcuj8O1SMNh6qRc';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const tableBody = document.getElementById('table-body');
const statusOutput = document.getElementById('status-output');
let selectedRowId = null;

function setStatus(msg){ statusOutput.value = msg; }
function formatCurrency(v){ return "‚Ç¨" + parseFloat(v||0).toFixed(2); }

function setupTabs(){
  document.querySelectorAll('.tab-button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });
}

/* === CRUD === */
async function addAcquisto(){
  const data = document.getElementById('data-acquisto').value || new Date().toISOString().split('T')[0];
  const articolo = document.getElementById('articolo-acquisto').value.trim();
  const prezzo = parseFloat(document.getElementById('prezzo-acquisto').value);
  const guad = parseFloat(document.getElementById('guadagno-previsto').value)||0;
  if(!articolo || isNaN(prezzo)){ setStatus("‚ö†Ô∏è Dati mancanti"); return; }

  const { error } = await supabaseClient.from('movimenti').insert([{data,articolo,acquisto:prezzo,guadagno_previsto:guad,vendita:0,stato:'Acquistato'}]);
  if(error) setStatus("‚ùå Errore: "+error.message);
  else { setStatus("‚úÖ Acquisto aggiunto"); refreshData(); }
}

async function updateMovimento(vendita=false){
  if(!selectedRowId){ setStatus("‚ö†Ô∏è Seleziona una riga"); return; }
  const payload={};
  const art=document.getElementById('nuovo-articolo').value.trim();
  const acq=parseFloat(document.getElementById('nuovo-acquisto').value);
  const ven=parseFloat(document.getElementById('prezzo-vendita').value);
  if(art) payload.articolo=art;
  if(!isNaN(acq)) payload.acquisto=acq;
  if(vendita||!isNaN(ven)){payload.vendita=ven;payload.stato='Venduto';}

  const {error}=await supabaseClient.from('movimenti').update(payload).eq('id',selectedRowId);
  if(error) setStatus("‚ùå "+error.message); else { setStatus("‚úÖ Modificato"); refreshData(); }
}

async function deleteMovimento(){
  if(!selectedRowId) return setStatus("‚ö†Ô∏è Seleziona una riga");
  if(!confirm("Eliminare riga "+selectedRowId+"?")) return;
  const {error}=await supabaseClient.from('movimenti').delete().eq('id',selectedRowId);
  if(error) setStatus("‚ùå "+error.message); else { setStatus("üóëÔ∏è Eliminato"); refreshData(); }
}

/* === TAB LISTA === */
async function refreshData(){
  const { data, error } = await supabaseClient.from('movimenti').select('*').order('id',{ascending:false});
  if(error){ setStatus("‚ùå "+error.message); return; }
  renderTable(data);
}
function renderTable(data){
  tableBody.innerHTML='';
  data.forEach(m=>{
    const row=document.createElement('tr');
    row.innerHTML=`<td>${m.id}</td><td>${m.data}</td><td>${m.articolo}</td><td>${formatCurrency(m.acquisto)}</td>
    <td>${formatCurrency(m.vendita)}</td><td>${formatCurrency(m.guadagno_previsto)}</td><td>${m.stato}</td><td>${formatCurrency((m.vendita||0)-(m.acquisto||0))}</td>`;
    row.onclick=()=>{document.querySelectorAll('tr').forEach(r=>r.classList.remove('selected-row'));row.classList.add('selected-row');selectedRowId=m.id;setStatus("ID "+m.id+" selezionato");document.querySelector('.tab-button[data-tab=\"tab-gestione\"]').click();document.getElementById('id-modifica').value=m.id;document.getElementById('nuovo-articolo').value=m.articolo;document.getElementById('nuovo-acquisto').value=m.acquisto;document.getElementById('prezzo-vendita').value=m.vendita||'';};
    tableBody.appendChild(row);
  });
}

/* === PWA === */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/mercatino/sw.js')
    .then(reg=>console.log('‚úÖ SW registrato:',reg.scope))
    .catch(err=>console.error('‚ùå SW fallito:',err));
  });
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault(); deferredPrompt=e;
  const b=document.createElement('button');
  b.textContent='üì≤ Installa App';
  b.style='position:fixed;bottom:20px;right:20px;padding:10px 15px;background:#4f46e5;color:#fff;border:none;border-radius:8px;z-index:9999;';
  document.body.appendChild(b);
  b.addEventListener('click',async()=>{b.remove();deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;});
});
window.addEventListener('appinstalled',()=>console.log('‚úÖ App installata!'));

/* === INIT === */
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('data-acquisto').value=new Date().toISOString().split('T')[0];
  setupTabs();
  refreshData();
  document.getElementById('btn-acquisto').onclick=addAcquisto;
  document.getElementById('btn-modifica').onclick=()=>updateMovimento(false);
  document.getElementById('btn-vendita').onclick=()=>updateMovimento(true);
  document.getElementById('btn-elimina').onclick=deleteMovimento;
  document.getElementById('btn-filtra').onclick=refreshData;
  document.getElementById('btn-reset-all').onclick=refreshData;
});
</script>
</body>
</html>
